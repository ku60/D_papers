                                                                                  
                                                                                  
     Article                                                                      
                                                                                  
     Connectome-constrained                     networks        predict           
                                                                                  
     neural      activity    across     the   fly  visual    system               
                                                                                  
                                                                                  
                                                                                  
                                                                                  
     https://doi.org/10.1038/s41586-024-07939-3 Janne K. Lappalainen1,2,3, Fabian D. Tschopp3, Sridhama Prakhya3, Mason McGill3,4,
                              Aljoscha Nern3, Kazunori Shinomiya3, Shin-ya Takemura3, Eyal Gruntman3,5,
     Received: 16 March 2023                                                      
                              Jakob H. Macke1,2,6 & Srinivas C. Turaga3 ✉         
     Accepted: 9 August 2024                                                      
     Published online: xx xx xxxx                                                 
                              We can now measure the connectivity of every neuron in a neural circuit1–9, but we
     Open access              cannot measure other biological details, including the dynamical characteristics of
       Check for updates      each neuron. The degree to which measurements of connectivity alone can inform the
                              understanding of neural computation is an open question10. Here we show that with
                              experimental measurements of only the connectivity of a biological neural network,
                              we can predict the neural activity underlying a specified neural computation. We
                              constructed a model neural network with the experimentally determined connectivity
                              for 64 cell types in the motion pathways of the fruit fly optic lobe1–5 but with unknown
                              parameters for the single-neuron and single-synapse properties. We then optimized
                              the values of these unknown parameters using techniques from deep learning11, to
                              allow the model network to detect visual motion12. Our mechanistic model makes
                              detailed, experimentally testable predictions for each neuron in the connectome.
                              We found that model predictions agreed with experimental measurements of neural
                              activity across 26 studies. Our work demonstrates a strategy for generating detailed
                              hypotheses about the mechanisms of neural circuit function from connectivity
                              measurements. We show that this strategy is more likely to be successful when
                              neurons are sparsely connected—a universally observed feature of biological neural
                              networks across species and brain regions.          
     Electrical signals propagating through networks of neurons form the artificial neural network architectures that can be trained to perform
     basis of computations such as visual motion detection. The propaga- the same computational task11. Such differences in connectivity can
     tion of neural activity is shaped by both the functional properties of correspond to qualitatively different computational mechanisms16.
     individual neurons and their synaptic connectivity. Additional fac- Similarly, in neuroscience there have been competing proposals for the
     tors10,13, including electrical synapses, neuromodulation and glia, are same computation (for instance, the computation of visual motion)17,18.
     known to further influence neural activity on multiple timescales. Furthermore, even circuits with the same connectivity can function
     Volume electron microscopy can now be used to comprehensively differently19. Thus, neither the connectivity of a circuit alone, nor its
     measure the connectivity of each neuron in a neural circuit, and even computational task alone, can uniquely determine the mechanism of
     entire nervous systems1–9. However, we do not yet have the means to circuit function20.
     also comprehensively measure all other biological details, including Here we show that the connectivity of a neural circuit, together with
     the dynamical properties of every neuron and synapse in the same knowledge of its computational task, enables accurate predictions of
     circuit13. For these reasons, there has been considerable debate about the role played by individual neurons in the circuit in the computational
     the utility of connectome measurements for understanding brain func- task. We constructed a differentiable21 model neural network with a
     tion14. It is unclear whether it is possible to use only measurements of close correspondence to the brain, whose connectivity was given by
     connectivity to generate accurate predictions about how the neural connectome measurements and with unknown single-neuron and
     circuit functions, especially in the absence of direct measurements single-synapse parameters. We optimized the unknown parameters
     of neural activity from a living brain. There is considerable evidence of the model using techniques from deep learning11, to enable the
     from computer science and neuroscience that there is not necessar- model to accomplish the computational task22. We call such models
     ily a strong link between the connectivity of a neural network and its connectome-constrained and task-optimized deep mechanistic net-
     computational function. Universal function approximation theorems works (DMNs) (Fig. 1a).
     for artificial neural networks15 imply that the same computational task We applied this approach to model the motion pathways in the optic
     can be performed by many different networks with very different neural lobe of the Drosophila visual system. We constructed a DMN with experi-
     connectivity. Empirically, there exist many classes of general-purpose mentally measured connectivity1–5, and unknown parameters for the
     1Machine Learning in Science, Tübingen University, Tübingen, Germany. 2Tübingen AI Center, Tübingen, Germany. 3Janelia Research Campus, Howard Hughes Medical Institute, Ashburn,
     VA, USA. 4Computation and Neural Systems, California Institute of Technology, Pasadena, CA, USA. 5Dept of Biological Sciences, University of Toronto Scarborough, Toronto, Ontario, Canada.
     6Max Planck Institute for Intelligent Systems, Tübingen, Germany. ✉e-mail: turagas@janelia.hhmi.org
                                                              Nature | www.nature.com | 1

                                                                                  
                                                                                  
     Article                                                                      
                                                                                  
      a                   b                      c                                
                                  Mi Neural activity T2 Lobula plate              
                 measurements Lawf      T3 T4                                     
                                              T5                                  
      V inis pu ua tl mC eo an sn ue rec mto em ne ts Match? Light                
                            L1–L5                                                 
                  Neural activity                                                 
                  predictions R1–R8 Tm       Lobula                               
           DMN Task optimization                                                  
                            Retina Lamina Medulla Central brain                   
                                                                                  
                                                                                  
                                                                                  
                                                               Postsynaptic       
                                                                                  
                                                                                  
                                                                                  
              RRR111 RRR555 LLL111 LLL555 CCC222 MMMiii111 MMMiii999 MMMiii111333 TTT111 TTT444aaa TTT555aaa TTTmmm111 TTTmmm555YYY TTTmmm999 TTTmmm333000 TTTmmmYYY999 TTTmmmYYY111555
                                                                                  
              RRR222 RRR666 LLL222 LLLaaawwwfff111 CCC333 MMMiii222 MMMiii111000 MMMiii111444 TTT222 TTT444bbb TTT555bbb TTTmmm222 TTTmmm555aaa TTTmmm111666 TTTmmmYYY333 TTTmmmYYY111000 TTTmmmYYY111888
              RRR333 RRR777 LLL333 LLLaaawwwfff222 CCCTTT111(((LLLooo111))) MMMiii333 MMMiii111111 MMMiii111555 TTT222aaa TTT444ccc TTT555ccc TTTmmm333 TTTmmm555bbb TTTmmm222000 TTTmmmYYY444
                                                                                  
              RRR444 RRR888 LLL444 AAAmmm CCCTTT111(((MMM111000))) MMMiii444 MMMiii111222 TTT333 TTT444ddd TTT555ddd TTTmmm444 TTTmmm555ccc TTTmmm222888 TTTmmmYYY555aaa
                                                                                  
                Retina  Lamina, medulla intrinsic cells, CT1 T-shaped, transmedullary cells
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
     single-neuron dynamics and the strength of a unitary synapse. We has a one-to-one correspondence with the ommatidia, both possessing
     optimized the model parameters on the computer vision task of detect- a remarkably crystalline organization in a hexagonal lattice. Visual input
     ing motion in dynamic visual stimuli12. Visual motion computation from the photoreceptors is received by the lamina and medulla, which
     in the fly and its mechanistic underpinnings have been extensively send projections to the lobula and lobula plate25 (Fig. 1b). Many com-
     studied23. Thus, we were able to compare the detailed predictions ponents of the optic lobe are highly regular, with columnar cell types
     of our model with experimental measurements of neural activity in appearing once per column, and multicolumnar neurons appearing
     response to visual stimuli, on a neuron-by-neuron basis. We found with only small deviations from a well-defined periodicity in columnar
     that our connectome-constrained and task-optimized DMN accurately space25,26. Several studies have reported on the local connectivity in the
     predicts the separation of the visual system into light-increment (ON) optic lobe and its motion pathways1–5. We assembled these separate
     and light-decrement (OFF) channels, as well as the generation of direc- local reconstructions into a coherent local connectome spanning the
     tion selectivity in the well-known T4 and T5 motion detector neurons24. retina, lamina, medulla, lobula and lobula plate (Fig. 1c, Supplementary
     We release our model as a resource for the community (https://github. Note 1, Supplementary Fig. 1 and Supplementary Data files 1–3).
     com/TuragaLab/flyvis).                We approximated the circuitry across the entire visual field as per-
                                          fectly periodic2,26, and tiled this local connectivity architecture in a
                                          hexagonal lattice across retinotopic space to construct a consensus
     DMN of the fly visual system                                                 
                                          connectome for 64 cell types across the central visual field of the right
     The optic lobes of the fruit fly are equivalent to the mammalian retina. eye (Fig. 1d, Methods, Extended Data Fig. 1, Supplementary Fig. 2 and
     They comprise several layered neuropils whose columnar arrangement Supplementary Data file 4). By this assumption of translation invariance
     2 | Nature | www.nature.com                                                  
                                                  citpanyserP                     
                                                  R1–R8                           
                                                  L1–L5 Lawf Am                   
                                                  C2–C3 CT1                       
                                                   Mi                             
                                                   T                              
                                                   Tm                             
                                                     8R–1R 5L–1L fwaL mA 3C–2C 1TC iM T mT
      d             Lobula plate                                                  
      Light                                                                       
        Retina LaminaMedulla Lobula                                               
                    Central brain                                                 
      g                                                                           
         Video                                                        Optic flow  
                                                               Decoded Motion     
           Fly eye                                              (putative decoder 
          rendering                                             output            
                                                                neurons)          
        ... ...                                                          ...      
                                                             Synapse count –120 –70 –20 20 70 120
                          e            f                                          
                                        Passive point-neuron                      
                          Mi9   T4d       dynamics                                
                           –7.9–8.2 –2.9 ττtiV i = –V i + Σ js ij + V tr iest     
                             –2.1       Instantaneous-graded-                     
                             –1.1        release synapses                         
                               Dorsal     s = wf(V)                               
                                           ij ij j                                
                               u                                                  
                                 vAnterior w ij = ααtitjσtitjN titj,ui–uj,vi–vj   
                                                                          90º30º  
                                                                            0º    
       Sintel                                                                     
       video                                                                      
        clip                                                                      
     Fig. 1 | Connectome-constrained and task-optimized models of the fly visual d, Retinotopic hexagonal lattice columnar organization of visual system model.
     system. a, DMNs aim to satisfy three constraints: the architecture is based on Each lattice represents a cell type; each hexagon represents an individual cell.
     connectome measurements (b–e); cellular and synaptic dynamics are given Positions of photoreceptor ommatidia are aligned with downstream columns.
     by simple mechanistic models (f); and free parameters are task-optimized by The model comprises synapses from all neuropils (Supplementary Fig. 1).
     training the model to perform optic flow estimation (g). Graphics of fruit fly e, Example of convolutional filter, representing Mi9 inputs onto T4d cells.
     and microscope were created with BioRender.com. b, Schematic of optic lobe Values represent the average number of synapses projecting from presynaptic
     of D. melanogaster with several processing stages (neuropils) and cell types, Mi9 cells in columns with indicated offset onto the postsynaptic dendrite of T4d
     including photoreceptor (R1–R8), lamina monopolar (L), lamina wide-field cells. f, Single-neuron and synaptic dynamics are given by simple mechanistic
     (Lawf), medulla intrinsic (Mi), transmedullary (Tm) and T-shaped (T) neurons models. Free parameters (magenta) are optimized by training the recurrent
     (adapted from ref. 25, Springer Nature). Scale bar, 10 μm. c, Identified network model to perform optic flow estimation. g, Illustration of DMN
     connectivity between 64 modelled cell types, represented by total number of performing optic flow estimation. Each hexagonal lattice shows a snapshot of
     synapses from all neurons of a given presynaptic cell type to a postsynaptic cell simulated voltage levels of all cells of each type in response to input to the
     of a given type. Amacrine (Am), centrifugal (C2–C3) and complex tangential (CT) photoreceptors (R1–R8). Edges illustrate connectivity between cell types. A
     neurons are also included. Blue (red) colour indicates putative hyperpolarizing decoder receives the simulated neural activity of all output neurons to compute
     (depolarizing) inputs; size of squares indicates number of input synapses. optic flow. Parameters of DMN and decoder are optimized using deep learning.

                                                                                  
                                                                                  
                                                                                  
                                                                                  
     due to periodic tiling, the synapse count between each pair of neurons As the computational task constraining the input–output function
     was the same across all pairs of neurons with the same presynaptic of the circuit, we chose the computation of visual motion from natu-
     and postsynaptic cell type and relative location in retinotopic space. ralistic stimuli12. Motion computation in the fly visual system and its
     For simplicity, we refer here to this partial connectome of the motion mechanistic underpinnings have been extensively studied23. This com-
     pathways as the connectome.          putation requires the neural circuit to compare visual stimuli across
       We built a recurrent neural network modelling these first stages of space and time, and thereby critically relies on temporal integration
     visual processing in the optic lobe based on the connectome for the of visual information by the dynamics of the network. We reasoned
     right eye. Each neuron in this DMN corresponds to a real neuron in the that training our model to perform the computer vision task of optic
     fly visual system, belonging to an identified cell type, and is connected flow computation12 could help us identify circuit elements involved in
     to other neurons only if they are connected by synapses in the connec- motion computation. As our model contains many of the circuit ele-
     tome (Fig. 1e). We constructed a model with detailed connectivity, but ments that have been experimentally characterized and implicated in
     simplified models of single neurons and chemical synapses (Fig. 1f). the computation of visual motion, we could then validate our model
     We used passive leaky linear non-spiking voltage dynamics to model predictions.
     the time-varying activity of single neurons, as many neurons in the To decode optic flow from the DMN, we used a decoding network to
     early visual system are non-spiking. We modelled neurons with a single map the representation of motion used in the fly nervous system to the
     electrical compartment, as this has previously been shown to be a good representation of optic flow specified by the computer vision task. This
     approximation given the small size of many neurons in the optic lobe27. two-layer convolutional decoding network is given only the instanta-
     The CT1 (complex tangential) neuron, which is among the largest in the neous neural activity of the medulla and downstream areas as input.
     brain, spanning the entire optic lobe, was modelled with one compart- Importantly, the decoding network cannot by itself detect motion,
     ment per column in the medulla and lobula, as it is highly electrotoni- which requires the comparison of current and past visual stimuli, but
     cally compartmentalized28 (Supplementary Note 2). We modelled the must instead rely on the temporal dynamics of the DMN to compute
     graded-release chemical synapses between non-spiking neurons with a motion-selective visual features. The resulting combination of our
     threshold-linear function to approximate the nonlinear voltage-gated recurrent connectome-constrained DMN model and the feedforward
     release of neurotransmitters. The resulting network model follows decoding network was then trained end-to-end: we rendered video
     well-known threshold-linear dynamics and is piece-wise differentiable. sequences from the Sintel database12 as direct input to the photore-
     Such dynamics are typically used to approximate the firing rates of a ceptors of the connectome-constrained model, and used gradient
     network of spiking neurons with the nonlinearity arising from spike descent (backpropagation through time11) to minimize the task error
     generation, whereas in our network, the nonlinearity represents the in predicting optic flow (Fig. 1g and Methods).
     voltage-gated neurotransmitter release. We used the cell-type struc-         
     ture of the connectome to reduce the number of free parameters in the        
                                          DMN ensemble predicts known activity    
     model (Fig. 1f). We assumed that neurons of the same cell type shared        
     the same neuron time constant and resting membrane potential. We We used only connectome and task constraints to construct our DMN,
     modelled synaptic weights as proportional to the discrete number of without any measurements of neural activity. We can therefore vali-
     synapses as reported in the connectome between a connected neuron date the model by comparing predictions of neural activity for each
     pair29, with a scale factor representing the strength of a unitary synapse. of the 64 identified cell types to experimental measurements. As it is
     The unitary synapse scale factor and the sign of each synapse was the possible that these constraints might not uniquely constrain model
     same for all pairs of neurons with the same pre- and postsynaptic cell parameters32, we generated an ensemble of 50 models, all constrained
     type. In other words, a connection of five synapses from an Mi1 (medulla with the same connectome, and optimized to perform the same task.
     intrinsic) neuron to a T4 (T-shaped) neuron is assumed to be exactly Each model in the ensemble corresponds to a local optimum of task
     half as strong as ten synapses between another pair of neurons of the performance. As the models achieved similar (but not identical) task
     same presynaptic and postsynaptic cell types, but could be stronger or performance, the ensemble reflects the diversity of possible models
     weaker than five synapses between neurons of a different cell-type pair, consistent with these constraints. The ensemble of models found a
     for instance, from a Tm3 (transmedullar) neuron to a T4 neuron. The variety of parameter configurations (Supplementary Fig. 3), and exhib-
     sign of each cell-type connection was determined by neurotransmitter ited superior task performance to both the decoder network alone and
     and receptor expression profiling30 (Methods and Supplementary Data models with random parameter configurations (Extended Data Fig. 2a).
     file 2). In total, the connectome-constrained model comprises 45,669 We focused on the ten models that achieved the best task performance
     neurons and 1,513,231 connections, across 64 cell types arranged in (Fig. 2a). We simulated neural responses to multiple experimentally
     a hexagonal lattice consisting of 721 columns, modelling the central characterized visual stimuli, and comprehensively compared model
     visual field of the roughly 700–900 ommatidia typically found in the responses for each cell type to experimentally reported responses
     fruit fly retina31. Connectome constraints, and our assumption of spa- from 26 previously reported studies (Supplementary Note 3 and Sup-
     tial homogeneity (that is, the hexagonally convolutional structure of plementary Data files 5 and 6).
     the network), result in a marked reduction to just 734 free parameters First, neural responses in the fly visual system are known to segregate
     for this large network model. The only free parameters in our model into ON- and OFF-channels33 defined by whether a neuron depolar-
     are the single-neuron time constants and resting membrane potentials izes more strongly to an increase or decrease in stimulus intensity,
     (two parameters per cell type), and the unitary synapse strengths (one respectively, a hallmark of visual computation across species34,35. We
     parameter per type-to-type connection). In the absence of connectome probed the contrast preference of each cell type using flash stimuli36
     measurements, we would have needed to estimate well in excess of and found that the ensemble predicts the segregation into ON- and
     a million parameters corresponding to the weights of all possible OFF-pathways with high accuracy: the median flash response index
     connections (Methods).               (FRI) across the ensemble predicts the correct ON- and OFF-preferred
       We used task optimization22 to further constrain the parameters of contrast selectivity for all 32 cell types for which contrast selectivity
     the model (that is, by training the model to perform a computational has been experimentally established (terminals of CT1 in the medulla
     task that is thought to approximate the computations carried out by and lobula are listed as CT1(M10) and CT1(Lo1)). This is also the case
     the circuit). We therefore implemented our recurrent DMN using the for the model with the best task performance (task-optimal model),
     PyTorch library21 (Methods) and used automatic differentiation to opti- which correctly predicts the preferred contrast of 30 of 32 cells (Fig. 2b).
     mize the model using gradient-based deep learning training methods11. Furthermore, the ensemble provides predictions for the remaining
                                                              Nature | www.nature.com | 3

                                                                                  
                                                                                  
     Article                                                                      
                                                                                  
      a                                                                           
                    Connectome                                                    
                     constraints Task         Simple       Quantify               
                              training        stimuli      statistics             
                                   50 trained                                     
                                   models                                         
                     Initialization of biophysical 10                             
                     parameters 0                                                 
                                5.25 5.50 5.75                                    
                                 Task error                                       
      b                                                                           
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
          Full DMN                                                                
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
     33 cell types, and consistency across the ensemble provides a measure the lack of motion tuning in the input neurons to T4 and T5 motion
     of confidence in the predictions (Fig. 2b). detector neurons (Mi1, Tm3, Mi4, Mi9, Tm1, Tm2, Tm4, Tm9 and CT1;
       Second, a major result in fly visual neuroscience has been the Methods and Supplementary Data file 7).
     identification of the T4 (ON) and T5 (OFF) neurons as the first Our models also suggest the possibility that the transmedullary
     direction-selective neurons with four subtypes (T4a, T4b, T4c and cell types, TmY3, TmY4, TmY5a, TmY13 and TmY18, might be tuned to
     T4d, and T5a, T5b, T5c and T5d), each responding to motion in the ON-motion. Of these cell types, TmY3 neurons do not receive inputs
     four cardinal directions37. We characterized the motion selectivity of from other known motion-selective neurons suggesting the possi-
     all 64 cell types by their responses to ON- and OFF-edges moving in 12 bility that these neurons constitute a parallel motion computation
     different directions. We found that the ensemble of models correctly pathway from T4 and T5 neurons (Extended Data Figs. 3 and 4 and
     predicts that T4 neurons are ON-motion selective, and T5 neurons are Supplementary Note 4). We questioned whether our model predicted
     OFF-motion selective (Fig. 2c). The ensemble also correctly predicts motion selectivity for all cell types with asymmetric, multicolumnar
     4 | Nature | www.nature.com                                                  
                            fo rebmuN sledom        Responses                     
           1R 2R 3R 4R 5R 6R 7R 8R 5L 3C )01M(1TC 1iM 4iM a4T b4T c4T d4T 3mT 1L 2L 3L 4L )1oL(1TC 9iM a5T b5T c5T d5T 1mT 2mT 4mT 9mT 1fwaL 2fwaL mA 2C 2iM 3iM 01iM 11iM 21iM 31iM 41iM 51iM 1T 2T a2T 3T Y5mT a5mT b5mT c5mT 61mT 02mT 82mT 03mT 3YmT 4YmT a5YmT 9YmT 01YmT 31YmT 41YmT 51YmT 81YmT
          1.0                                                                     
          0.5                                                                     
          0                                                                       
         –0.5                                                                     
         –1.0                                                                     
       IRF                                                                        
                                                              Best task-performing model
            ON-flash Known ON-contrast selective              Median              
        ON                                                                        
       OFF                                                                        
            OFF-flash             Known OFF-contrast selective                    
      c                                                                           
           1R 2R 3R 4R 5R 6R 7R 8R 5L 3C )01M(1TC 1iM 4iM a4T b4T c4T d4T 3mT 1L 2L 3L 4L )1oL(1TC 9iM a5T b5T c5T d5T 1mT 2mT 4mT 9mT 1fwaL 2fwaL mA 2C 2iM 3iM 01iM 11iM 21iM 31iM 41iM 51iM 1T 2T a2T 3T Y5mT a5mT b5mT c5mT 61mT 02mT 82mT 03mT 3YmT 4YmT a5YmT 9YmT 01YmT 31YmT 41YmT 51YmT 81YmT
         1.0                                                                      
         0.5                                                                      
          0                                                                       
       ISD                                                                        
       ISD                                                                        
                  Known ON-motion                             Best task-performing model
                     selective                                Median              
            ON-edge                                                               
                             Known OFF-motion                                     
            OFF-edge            selective                                         
      d  1.0                                                                      
         0.5                                                                      
         0                                                                        
        –0.5                                                                      
               FRI        T4 motion-tuning curves T5 motion-tuning curves         
        –1.0                                                                      
       noitalerroC                                                                
                 Vατt                                                             
                  rti eit sjt                                                     
                  ti                                                              
          0                                                                       
         0.5                                                                      
         1.0                                                                      
                    Random DMN                DMNs with different connectome constraints
         Cell-type connectivity Cell-type connectivity Cell-type connectivity Cell-type connectivity Cell-type connectivity Cell-type connectivity Cell-type connectivity
        SinN gle eu -nro en                                                       
           u                                                                      
           rp oa nr a cm one nte er cs                                            
               t                                                                  
               i( vτ it ti, yV tr iest) SingN lee -u nr eo un                     
                      r                                                           
                      op na r ca om ne nt ee crs                                  
                         tivity                                                   
                             SingN lee -u nr eo un                                
                                r                                                 
                                op na r ca om ne nt ee crs                        
                                   tivity                                         
                                       SingN lee -u nr eo un                      
                                          r                                       
                                          op na r ca om ne nt ee crs              
                                             tivity                               
                                                 SingN lee -u nr eo un            
                                                    r                             
                                                    op na r ca om ne nt ee crs    
                                                        tivity                    
                                                           SingN lee -u nr eo un  
                                                              r                   
                                                               op na r ca om ne nt ee crs
                                                                  tivity          
                                                                    SingN lee -u nr eo un
                                                                        r         
                                                                        op na r ca om ne nt ee crs
                                                                           tivity 
       Uni Sta yr                                                                 
         7n                                                                       
         Sy                                                                       
         3a                                                                       
         ys                                                                       
          4p                                                                      
          ny                                                                      
          s a                                                                     
          fn                                                                      
          re p                                                                    
           ea                                                                     
           s                                                                      
           ep                                                                     
           c e                                                                    
           os                                                                     
            p                                                                     
            e                                                                     
            u s                                                                   
            a                                                                     
            n                                                                     
            is                                                                    
            rgt                                                                   
             at nsr                                                               
             m                                                                    
             se                                                                   
             (                                                                    
             Nn e(σg                                                              
              tt ei                                                               
              ttt                                                                 
              ij tΔ                                                               
              rh                                                                  
               jsu                                                                
               )s                                                                 
               Δ                                                                  
               v( )αtitj) Unita Sr sy                                             
                    y y                                                           
                     ns nay an                                                    
                     p p                                                          
                      7a                                                          
                      s s                                                         
                      3p                                                          
                      e e                                                         
                       4s ce                                                      
                       so i                                                       
                       gs                                                         
                        u                                                         
                        nt nr ste sngths Unita Sr Sy                              
                               y                                                  
                               yns nay an                                         
                                p                                                 
                                2pa                                               
                                s ,s                                              
                                4p                                                
                                e e                                               
                                 8                                                
                                 s                                                
                                 c                                                
                                 5e                                               
                                 so                                               
                                  igs ut nnr ste sngths Unita Sr Sy               
                                         y                                        
                                         yns nay                                  
                                          a                                       
                                          1n                                      
                                          p                                       
                                          1pa                                     
                                          s                                       
                                          ,sp                                     
                                          e 5e                                    
                                           s                                      
                                           9c                                     
                                           e                                      
                                           s 3o                                   
                                            igs ut nnr ste sngths Unita Sr Sy     
                                                   y                              
                                                   yns nay an                     
                                                    p p                           
                                                    7a                            
                                                    s s                           
                                                     9p                           
                                                     e e                          
                                                     7                            
                                                     s                            
                                                     c                            
                                                      e                           
                                                      so                          
                                                      igs ut nnr ste sngths Unita Sr Sy
                                                             y                    
                                                             yns nay an           
                                                              p                   
                                                              2pa                 
                                                               s                  
                                                               ,4sp               
                                                               e e                
                                                               8                  
                                                               s                  
                                                                c                 
                                                                5e                
                                                                so                
                                                                igs ut nnr ste sngths Unita Sr Sy
                                                                      y           
                                                                       yns nay    
                                                                       a          
                                                                       1n         
                                                                       p          
                                                                        1pa       
                                                                        s         
                                                                        ,sp       
                                                                        e 5e      
                                                                         s        
                                                                         9c       
                                                                         e        
                                                                         s 3o     
                                                                         igs ut nnr ste sngths
       Type of constraint: Task-optimized Connectome-constrained Random           
     Fig. 2 | Ensembles of DMNs predict tuning properties. a, We task-optimized c, Direction selectivity index (DSI) from neural responses to moving edges;
     50 connectome-constrained DMNs, yielding different solutions for the same ten models as above. d, Correlations between measurements and
     biophysical parameters (magenta), and compared the tuning properties of predictions of neural activity from seven types of DMN with different
     their cell types to experimental measurements. Inset: distribution of task connectome and parameter constraints: FRI (pink); motion-tuning curves for
     errors. Blue: ten best models; also shown in b–d. b, ON- and OFF-contrast T4 (red) and T5 (turquoise); dashes indicate median correlation across models.
     selectivity indices (FRI) for each cell type from ten models with best task The first DMN type on the left corresponds to the main DMNs analysed in b,c
     performance (ten worst models in Extended Data Fig. 6). Yellow: cell types and all subsequent figures; the remaining six DMNs incorporate fewer
     known to be ON-selective. Violet: known OFF-selective types. Black: selectivity constraints. Ten best task-performing models from each DMN type.
     not yet established experimentally. Bold: inputs to optic flow decoder.      

                                                                                  
                                                                                  
                                                                                  
                                                                                  
     inputs, as this is a necessary connectivity motif for direction selectivity. 
                                          Predictions cluster across DMN ensemble 
     On the basis of their local spatial connectivity profiles, we estimated      
     that 19 cell types receive asymmetric, multicolumnar inputs (Methods We sought to determine how similar or dissimilar the predictions of
     and Extended Data Fig. 5b), but found that only 12 are predicted to be different models in an ensemble with the same connectome constraints
     motion selective by the ensemble (Methods). Spatial offset of excita- and task optimization are. To address this for each cell type, we simu-
     tory and/or inhibitory inputs did not correlate strongly with direction lated neural activity in response to naturalistic video sequences from
     selectivity (Extended Data Fig. 5c,d). This suggests that our model inte- the Sintel dataset. We then used uniform manifold approximation
     grates connectivity across the entire network with the task constraint and projection38 to perform nonlinear dimensionality reduction on
     to determine which neurons are most likely to be motion selective, high-dimensional activity vectors of a representative neuron of each
     rather than simply focusing on local connectivity. cell type across the model ensemble, and clustered the models in the
                                          resulting two-dimensional projections (Fig. 3a and Methods). For many
                                          cell types, we found that models predict strongly clustered neural
     Connectome and task are both necessary                                       
                                          responses (Supplementary Data file 7). For T4c neurons, for exam-
     We investigated the importance of connectome constraints and task ple, we found three clusters corresponding to qualitatively distinct
     optimization to enable accurate predictions of neural activity. We found responses of this cell type for naturalistic inputs: two clusters con-
     that both task optimization and detailed connectome constraints at tain models with direction-selective T4c cells (Fig. 3a,b) with up- and
     the single-neuron resolution were critical to the prediction of the pre- down-selective cardinal tuning, respectively, whereas neurons in the
     ferred contrast of the 32 characterized cell types, and the preferred third cluster are not direction-tuned. The direction-selective cluster
     direction of motion for the T4 and T5 subtypes (Fig. 2d and Extended with the (correct) upward preference has the lowest average task error
     Data Fig. 2).                        (circular marker, average task error 5.297), followed by the cluster with
       We conducted ‘ablation’ studies comparing the DMN ensemble stud- the opposite preference (triangular marker, average task error 5.316).
     ied in this paper (full DMN) with a range of models with other modelling The non-selective cluster has the worst performance (square marker,
     assumptions. First we verified the importance of task optimization by average task error 5.357), suggesting that models with accurate tuning
     constructing an ensemble (random DMN) with random single-cell and correlate with lower task error (see also Extended Data Fig. 2e).
     synapse parameters, and full connectome constraints. This ensemble We sought to determine what differences in circuit mechanisms
     yielded accurate predictions of preferred contrast, but poor predic- underlie the different predictions for direction selectivity in the three
     tions of direction selectivity and preferred direction. clusters (Fig. 3c). Our results showed that direction selectivity in the two
       We then studied which aspects of the connectome must be measured tuned clusters is associated with opposite preferred contrast tuning of
     accurately to lead to accurate predictions. We found that task-optimized Mi4 and Mi9 neurons, which provide direct flanking inhibitory input
     models with access to only cell-type connectivity predicted neural to T4 neurons (Fig. 3d). Models with the correct direction selectivity
     activity poorly. We then considered several scenarios adding more for T4 neurons also predict the correct contrast selectivity for Mi4 and
     connectome measurements beyond cell-type connectivity. We con- M9 neurons, and vice versa (Fig. 3e).
     sidered several scenarios: access to synapse signs and single-neuron Thus, the ensemble can be used to provide hypotheses about differ-
     connectivity but not strength, requiring task optimization of synapse ent circuit mechanisms that might underlie the response properties of
     counts; access to signs, but requiring optimization of single-neuron individual cells. Furthermore, it shows that experimentally measuring
     connectivity and synapse counts; full connectome measurements but the tuning of one neuron automatically translates to constraints on
     optimization of synapse signs; access to connectivity but optimization other neurons in the circuit. Here, filtering models in the ensemble with
     of both synapse counts and signs. Across these modelling assumptions, the experimentally measured direction selectivity for the T4c neurons
     we found that accurate predictions of contrast preference (FRI) were (by only selecting models from the correct cluster) is sufficient to cor-
     possible as long as measurements of the connection-signs were avail- rectly constrain the tuning of both Mi4 and Mi9 neurons.
     able, and that accurate predictions of the direction selectivity—but         
     not preferred direction—could be achieved with measurements of               
                                          Predicted mechanism of T4 and T5 tuning 
     cell connectivity, without the need for synapse count measurements           
     (Extended Data Fig. 2c). This demonstrates the importance of both Our DMN modelling approach enables a large number of model-based
     detailed connectome measurements and task optimization to achieve analyses, which can illuminate the mechanistic basis of computation in
     accurate predictions of neural activity. a circuit and suggest new visual stimuli for experimental characteriza-
       Across the ensemble constrained by all connectome measurements tion. We illustrate these analyses using averages from the model cluster
     and task training, we found that models that exhibited lower task with the best task performance (task-optimal cluster), focusing on
     error (Methods) also had more realistic tuning: models with higher the well-studied T4 and T5 neurons (Fig. 4). See Supplementary Data
     task performance predict the direction selectivity index of T4 and file 7 for a comprehensive set of analyses for all cell types and mod-
     T5 cells and their inputs better (r = 0.60, P = 2.6 × 10−6; Extended Data els. In the task-optimal cluster, the four subtypes of the T4 neurons
     Figs. 2e and 6b). This suggests the possibility of using task error to respond strongly to bright (ON) edges, and the four subtypes of the T5
     rank models in terms of their likelihood to accurately predict neural neurons to dark (OFF) edges, moving in the four cardinal directions, in
     activity.                            agreement with experimental findings27,37,39,40 (Fig. 4a). We probed the
       Our model relies on an accurate classification of neurons into cell mechanism of direction selectivity in T4 and T5 neurons (Fig. 4b and
     types to share single-neuron and synapse parameters across all neurons Extended Data Figs. 7 and 8). Examining the input currents to a single
     of the same cell type. We investigated the degree to which we could T4 neuron (Extended Data Fig. 7a), we found that fast excitatory input
     coarse-grain the cell-type categorization, leading to fewer cell types and and offset delayed inhibitory input currents enable T4 in the model
     fewer parameters (Extended Data Fig. 2a–d). We found that grouping to detect motion, in agreement with experimental findings27. The dif-
     the four T4 subtypes into a single T4 cell type, and grouping the four ferential response of T4 neurons to motion in the preferred versus null
     T5 subtypes into a single T5 cell type, had no negative impact on the direction is primarily produced by the differential timing of inhibition
     quality of ensemble predictions. However, grouping all 37 excitatory from Mi4. Additionally, excitatory T4-to-T4 currents between neurons
     cell types into a single E-type, 22 inhibitory cell types into a single I-type, with the same preferred direction lead to an increased response to
     and 4 mixed cell types into a single mixed type, led to poor performance coherent motion across the visual field. Although research into T4
     on par with the random DMN.          motion selectivity has largely focused on the role of feedforward inputs,
                                                              Nature | www.nature.com | 5

                                                                                  
                                                                                  
     Article                                                                      
                                                                                  
                                                    90º                           
                                                      45º                         
                                                        0º                        
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
     our modelling predicts an important role for the lateral connectivity single-ommatidium flashes; 5 ms to 300 ms duration; Methods). These
     between T4 neurons. The mechanisms in our model for T5 motion cells either depolarize (which we call ON-selective) or hyperpolarize
     computation are similar (Extended Data Fig. 8a), with differential timing (which we call OFF-selective) in response to light-increment flashes. The
     of inhibition from CT1, as well as excitation from Tm9, contributing to temporal response properties are correctly predicted for all except the
     motion-selective responses.          Tm4 cell in this model: for major T4 inputs, Mi1, Tm3 and Mi4 respond
       To relate the mechanism of direction selectivity to the well-studied with transient depolarization to ON-flashes. By contrast, CT1(M10)
     mechanisms of preferred direction enhancement and null direc- responds with a longer sustained depolarization. Mi9 hyperpolarizes.
     tion suppression, we compared the responses of T4 and T5 neurons For major T5 inputs, Tm1, Tm2, Tm9 and CT1(Lo1) respond with tran-
     to moving bars and static bars as in ref. 27. Consistent with voltage sient hyperpolarization. Tm4 is incorrectly predicted to depolarize.
     measurements27,40, voltage response predictions by our model show For lamina cell types, the DMNs predict biphasic hyperpolarization
     null direction suppression but no preferred direction enhancement in L1 and L2 and monophasic hyperpolarization in L3 and L4, as well
     (Extended Data Figs. 7b and 8b).     as depolarization in L5.                
       We computed and compared the spatial and temporal receptive For motion-selective neurons such as T4 and T5, the spatio-temporal
     fields of the major columnar input neurons to T4 and T5 neurons. These receptive fields are not separable in space and time. We character-
     input neurons have been the focus of multiple experimental studies ized the full spatio-temporal receptive field for T4c and T5c neu-
     of the motion detection pathways28,41–45 (Fig. 4d). In agreement with rons (Fig. 4f) using single-ommatidium ON- and OFF-flashes (20 ms;
     experimental findings28,43, the prediction of the DMNs is that Tm3 and Methods). ON-flashes on the leading side of the receptive field of the
     Tm4 have broad spatial receptive fields (two-column radius, 11.6°), ON-contrast, upwards-direction-selective T4c cell lead to fast depo-
     whereas Mi1, Mi4, Mi9, Tm1, Tm2, Tm9 and CT1 compartments in both larization, whereas ON-flashes on the trailing side lead to delayed
     medulla and lobula have narrow spatial receptive fields (single-column hyperpolarization, again matching experimental findings27. As T5c
     radius, 5.8°).                       is OFF-selective, its OFF-impulse responses are inverted, resembling
       We characterized the temporal response properties of cells in the the T4c spatio-temporal receptive field (Extended Data Fig. 9a). This
     motion pathways, including the lamina monopolar cells (L1–L5) and reflects that T5c implements a similar motion-tuning mechanism
     direct inputs to the T4 and T5 neurons. We simulated neural responses to OFF-edges as T4c to ON-edges, in agreement with experimental
     to single-ommatidium flashes of varying contrast and duration and findings40.
     compared them to empirically characterized temporal responses Finally, we show that the model can be used to design optimized
     (Fig. 4e). The model accurately predicts the preferred contrast of each stimuli. We used the task-optimal model to screen for video sequences
     cell type33 (that is, whether they depolarize more strongly to ON or OFF from the Sintel dataset that elicited the largest responses in the
     6 | Nature | www.nature.com                                                  
                                              egde-NO sesnopser                   
      a                                   b                                       
                 5.357                                                            
                         5.6                                                      
                         5.4                                                      
                                          c                                       
                         5.2                                                      
            5.316   5.297                                                         
                                               Excitatory synapses                
                                               Inhibitory synapses                
      d                                   e                                       
                          rorre                                                   
                          ksaT                                                    
         Example cell type: T4c                                                   
        UMAP 1                                                                    
       2                                                                          
       PAMU                                                                       
                              1.0                                                 
                              0.5                                                 
                               0                                                  
                               0                                                  
                              0.5                                                 
                              1.0                                                 
                             ISD                                                  
                             egde-NO                                              
                             ISD                                                  
                             egde-FFO                                             
                                                         Ref. 37                  
                                              pU                                  
                                               Front                              
                                     15                                           
                                     0                                            
                                     –5                                           
                                       sespanys                                   
                                       tupnI                                      
         Mi1   Tm3   Mi4   Mi9 CT1(M10)          1iM 3mT 4iM 9iM )01M(1TC         
                                               1.0                                
                                               0.5                                
                                               0                                  
                                              –0.5                                
                                              –1.0                                
                                          hsalF                                   
                                           xedni                                  
                                           esnopser                               
                                                           1iM 3mT 4iM 9iM )01M(1TC 1iM 3mT 4iM 9iM )01M(1TC
                                                                          5.6     
                                                                          5.4     
                                                                          5.2     
                                                 Known ON-selective Known OFF-selective
                                            ON                                    
                                            OFF                                   
                                                                            rorre 
                                                                            ksaT  
                                                         L1  Mi1                  
                                                             Tm3                  
                                                    R1–R6 L5 Mi4 T4a–T4d          
                                                             Mi9                  
                                                         L3   CT1(M10)            
     Fig. 3 | Cluster analysis of DMN ensembles enables hypothesis generation Blue and red colour: putative hyper- and depolarizing inputs. Saturation:
     and suggests experimental tests. We clustered 50 DMNs after carrying out average number of input synapses for each offset location. e, Tuning properties
     nonlinear dimensionality reduction of their responses to naturalistic scenes within each cluster reveal dependencies between T4 tuning and that of Mi4 and
     for each cell type, and aimed to identify whether clusters correspond to Mi9 cells in the ensemble: switching Mi4 (known ON-contrast selective) and
     qualitatively different tuning mechanisms. a, Responses of T4c cells exhibit Mi9 (known OFF-contrast selective) contrast preferences results in directionally
     three clusters, two with ON-motion direction selectivity (circular and triangular opposite motion-tuning solutions in T4. DMNs in first cluster (T4c in DMN
     marker) and one (square marker) without. b, T4c tuning in the three clusters. upwards tuned, circle) exhibit ON-selectivity for Mi1, Tm3, Mi4 and CT1(M10),
     Circular marker: upwards tuning (cluster with lowest average task error 5.297; and OFF-selectivity for Mi9. For ON-motion stimuli, in these DMNs T4c receives
     black: known tuning of T4c). Triangular marker: downwards (5.316 error). central depolarizing input from Mi1 and Tm3 and dorsal hyperpolarizing input
     Square marker: no motion tuning (5.357 error). c, Schematic of corresponding from Mi4 and CT1(M10).
     ON-motion detection pathway. d, Connectivity of major input elements to T4c. 

                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                        b                                         
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
      d                                                                           
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
      f                                                                           
                                                                                  
                                                                                  
        –180 –160 –140 –120 –100 –80 –60 –40 –20 0 –180 –160 –140 –120 –100 –80 –60 –40 –20 0
                       Time (ms)                          Time (ms)               
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
     motion-selective neurons (Fig. 4f, Methods and Supplementary Data resolution. Sparse connectivity is a hallmark of biological neural cir-
     file 7 for all cell types). One might expect that pure ON- or OFF-stimuli cuits. We questioned whether sparse connectivity enables DMNs to
     would elicit the largest responses in T4 and T5, respectively. However, make accurate predictions of neural activity. For sparsely connected
     we found both ON-and OFF-elements in optimized stimuli, suggesting circuits—assuming the connectome is known—there are fewer synapse
     an interplay between ON- and OFF-pathways. The stimulus that elicited parameters left to estimate using task optimization. We reasoned that
     the strongest response in the T4c cell was a central OFF-disc followed such networks might support fewer possible mechanisms by which to
     by an ON-edge moving upwards, matching the preferred direction of perform a given task, and so that a task-optimized DMN model is more
     the cell. Similarly, for the T5c cell, the stimulus that elicits the strongest likely to find the true mechanism and accurately predict single-neuron
     response is a central ON-disc followed by an OFF-edge moving upwards activity.
     in the preferred direction of the cell (Extended Data Fig. 9c for corre- We tested this hypothesis in a simulation (Fig. 5), by constructing
     sponding full-field naturalistic stimuli, numerically optimized stimuli feedforward artificial neural networks solving the classic MNIST (Mod-
     and preferred moving-edge stimuli). Taken together, these findings ified National Institute of Standards and Technology) handwritten
     show that the model predicts a large number of tuning properties for digit classification task. These networks had varying degrees of sparse
     the T4 and T5 cells and their inputs. connectivity, and random assignment of neurons as excitatory and
                                          inhibitory respecting Dale’s law (25 ground-truth networks for each
                                          sparsity level, Methods). We then simulated the process of making
     Sparsity leads to accurate predictions                                       
                                          connectome measurements from these ground-truth networks, and
     Here we consider when connectome-constrained and task-optimized building connectome-constrained task-optimized DMN simulations
     DMN models might accurately predict neural responses at single-neuron of each ground-truth network (Fig. 5a).
                                                              Nature | www.nature.com | 7
      sulumitS                                                                    
      a                                                    c                      
                90º   90º   90º   90º                                             
                   45º  45º   45º   45º                                           
                    0º    0º   0º    0º                                           
                T4a   T4b   T4c   T4d                                             
                90º   90º   90º   90º                                             
                   45º  45º   45º   45º                                           
                    0º    0º   0º    0º                                           
                T5a   T5b   T5c   T5d                                             
                                            e                                     
       T4c                                 T5c                                    
                                        ).u.a(                                    
                                        egatloV                                   
                                        ).u.a(                                    
                                        stnerruC                                  
                                                Preferred direction               
                                                Null direction                    
                                         100 ms                                   
                                                      Mi1                         
                                                      Tm3                         
                                                      T4c                         
                                                      Mi9                         
                                                      TmY15                       
                                                      CT1(M10)                    
                                                      Mi4                         
             ).u.a(                                                               
             egatlov                                                              
             kaeP                                                                 
             pU                                                                   
                                                                        ON-motion 
                 Ref. 37   Predicted ON-edge responses                            
                                                                      detection pathway
                                                                L1  Mi1           
                                                                    Tm3           
                                                                    Mi4  T4a–T4d  
                                                                L5                
                                                                    Mi9           
       ON-edges                                                       CT1(M10)    
                           Predicted OFF-edge responses     R1–R6 L3              
                                                                      CT1(Lo1)    
                                                                    Tm9           
                                                                L4                
                                                                    Tm4  T5a–T5d  
                                                                    Tm2           
                                                                L2  Tm1           
       OFF-edges                                            Excitatory synapses OFF-motion
              Front                                         Inhibitory synapses detection pathway
                                                    Mi1       Tm1        L1       
                                                    Tm3       Tm2        L2       
                                                    Mi4       Tm4        L3       
               Mi1   Tm3   Mi4  Mi9 CT1(M10)                                      
                                                    Mi9       Tm9        L4       
                                                    CT1(M10)  CT1(Lo1)   L5       
            Tm1   Tm2   Tm4  Tm9  CT1(Lo1)                             100 ms     
                                         Known ON-selective Known OFF-selective   
                                            ).u.a(                                
                                            ytivitcA                              
               Response to flash Hyperpolarization Steady state Depolarization    
                                                T4 inputs T5 inputs Lamina cells  
               at marked location                                                 
          Time                                                                    
      Single-ommatidium                                                           
      flash location                                                              
       T4 inputs                                                                  
       T5 inputs                            Single-ommatidium flashes             
                     1 column ≈ 5.8º Known narrow Known broad                     
     Fig. 4 | Task-optimal DMNs largely recapitulate known mechanisms of receptive fields of major motion detector input neurons revealed by
     motion computation. a, Responses to moving edges for T4 and T5 subtypes single-ommatidium flashes and comparison with experimental
     from task-optimal model clusters, and comparison with experimental measurements28,43. e, Single-ommatidium flash responses agree with
     measurements37,39 (null-contrasts in Supplementary Fig. 4). a.u., arbitrary experimental measurements41,43, with the exception of Tm4 (red cross).
     units. b, Voltage of T4c neuron (top) and contributions from major input cells f, Stimulus sequence predicted to elicit the strongest responses in T4c and T5c
     (bottom) during movement of an ON-edge across the visual field in preferred cells. A central OFF-disc followed by an ON-edge moving upwards elicits the
     (solid) and null (dashed) direction. c, Major cell types and connectivity in the strongest response in a T4c cell (ON-disc followed by OFF-edge for T5c).
     ON-motion (T4) and OFF-motion (T5) detection pathways (simplified). d, Spatial

                                                                                  
                                                                                  
     Article                                                                      
                                                                                  
      a                                               b                           
                    Ground-truth connectome Neural activity measurements          
                                                                                  
                                                                                  
                Neuron voltage Noisy connectome Compare                           
                V i = Σs ij + measurements model predictions Connectome-constrained synaptic input σj, c ij or σj, c ij, m ij for each neuron
        Input s                                                                   
               ij                                                                 
               = w ijf(V j) = σjc ijm ijf(V j)                                    
       stimuli                                                                    
                                  Neural activity predictions                     
                                    Stimuli                                       
                                                                Connectivity percentage
                     Simulated network                                            
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
       As the degree to which connection strength can be inferred from of the connectome played a critical role in this success, in part by lead-
     noisy connectome measurements is still unknown, we simulated two ing to a massive reduction in the number of free model parameters.
     settings. In the first, we assumed that connectome measurements We have taken a reductionist modelling approach, simplifying the
     reveal connectivity but not connection strength. In this setting, DMNs modelling of individual neurons and synapses, to focus on the role
     were task-optimized to infer both the resting membrane potential of played by the connectivity of a neural network. We found that for the
     each neuron, and the connection strength of each connected pair of motion pathways of the fruit fly visual system, this model correctly
     neurons. In the second, we assumed that the measurements additionally predicts many aspects of visual selectivity. We considered only the role
     reveal a noisy estimate of strength, which was used as a soft constraint of this circuit in detecting motion, which is but one of many computa-
     during task optimization.            tions performed by the visual system24. Our reductionist model cannot,
       Consistent with our hypothesis, our results showed that sparsity for example, account for the role played in this circuit by electrical
     in the connectome greatly improves the accuracy of neural activity synapses46, nonlinear chemical synapses47 and neuromodulation48.
     predictions with measurements of connectivity alone (Fig. 5b and However, richer models of neurons, synapses, plasticity and extrasyn-
     Supplementary Fig. 8; median Pearson correlations of 0.85 for 10% aptic modulation, along with a broader range of ethologically relevant
     connectivity versus 0.38 for 80% connectivity, 100 randomly selected tasks, can enable accurate modelling of these and other effects in the
     neurons from 25 randomly generated ground-truth networks). How- fly visual system and beyond.
     ever, with the additional availability of connection strength estimates, Task-optimized artificial neural network models, for instance of
     we find that DMN simulations accurately predict neural activity even mammalian visual pathways22, have previously demonstrated only
     in the absence of sparse connectivity (median Pearson correlation of a coarse correspondence of the population neural activity between
     >0.9 across all connectivities).     model layers and brain regions. By contrast, every neuron and synapse
       Our model of the fly visual system lies in an intermediate regime with in our connectome-constrained model49–53 has a direct correspondence
     regards to our knowledge of connection strength. We assumed that to neurons and synapses in the brain. This correspondence enables
     connectome measurements provided relative connection strength highly detailed experimentally testable predictions at the single-neuron
     but not absolute connection strength, as we assumed that the unitary resolution. Thus, our study more directly links artificial neural network
     synaptic strength was unknown but the same for connections of the models to the biological neural network.
     same cell-type pair. Thus, we attribute the success of our visual system Our modelling approach provides a discovery tool, aimed at using
     model at predicting neural activity to both the sparse structure of con- connectome measurements to generate detailed, experimentally test-
     nectivity in this circuit and also the estimates of connection strength able hypotheses for the computational role of individual neurons.
     from the synapse count.              Measurements of neural activity are necessarily sparse and involve
                                          difficult trade-offs. Activity can be measured in limited contexts,
                                          and either for a limited number of neurons or for a larger number of
     Discussion                                                                   
                                          neurons with poorer temporal resolution. Connectome-constrained
     We constructed a neural network with connectivity measured at the DMN models generate meaningful predictions even in the complete
     microscopic scale. We also required that, at the macroscopic scale, the absence of neural activity measurements, but can be further con-
     collective neural activity dynamics across the entire network result in an strained by sparse measurements of neural activity as we showed
     ethologically relevant computation. This combination of microscopic (Fig. 3), or indeed directly fitted to measured neural activity51 and
     and macroscopic constraints enabled us to constrain a large-scale behaviour54.
     computational model spanning many tens of cell types and tens of Whole-brain connectome projects have just been completed for
     thousands of neurons. We showed that such large-scale mechanis- the larval and adult fruit fly7,8,55,56, including two new connectomes of
     tic models could accurately make detailed predictions of the neural the entire fruit fly optic lobe6,9, and whole-mouse-brain connectome
     responses of individual neurons to dynamic visual stimuli, revealing projects are now being discussed57. Large-scale whole-nervous-system
     the mechanisms by which computations are performed. Knowledge models51,52,58 will be of critical importance for integrating connectomic,
     8 | Nature | www.nature.com                                                  
                                                       noitciderp                 
                                                       ytivitca                   
                                                       laruen                     
                                                       fo                         
                                                       ycaruccA                   
                                                        )noitalerroc              
                                                        nosraeP(                  
                                                           1.0                    
                                                           0.8                    
                                                           0.6                    
                    Vrest j i     ~                        0.4                    
                                                              Fly visual system model
                                                           0.2 Known signs, connectivity and
                                                              noisy synapse strengths
                                                              Known signs and connectivity
                                                           0                      
                                                              10 20  50   80      
     Fig. 5 | Connectome measurements constrain neural networks in simulated (light green) network. b, Median neural response correlation
     circuits with sparse connectivity. a, We constructed synthetic ‘ground- coefficients from 100 randomly sampled neuron pairs from each layer and
     truth connectome’ networks with varying degrees of sparse connectivity for across 25 network pairs. Two conditions were considered in which connectome
     classifying handwritten digits. For each ground-truth connectome network, measurements revealed either only binary connectivity (blue) or also connection
     we simulated connectome measurements and constructed a connectome- strength (orange). The fly visual system model presented here probably falls
     constrained and task-optimized the unknown parameters (magenta) in the in the region between the two curves, as measured synapse counts inform
     ‘simulated network’ (Methods). We measured the correlation of the neural relative connection strengths between pairs of neurons for the same pair of cell
     response vector, across all stimuli, between a ground-truth (dark green) and a types, but not absolute connection strength.

                                                                                  
                                                                                  
                                                                                  
                                                                                  
     transcriptomic, neural activity and animal behaviour measurements 30. Davis, F. P. et al. A genetic, genomic, and computational resource for exploring neural
     across laboratories, scales and the nervous system13. Furthermore, with circuit function. eLife 9, e50901 (2020).
                                          31. Götz, K. G. Optomotorische Untersuchung des visuellen systems einiger Augenmutanten
     the recent development of detailed biomechanical body models for der Fruchtfliege Drosophila. Kybernetik 2, 77–92 (1964).
     the fruit fly59,60, we can now contemplate constructing whole-animal 32. Marder, E. & Taylor, A. L. Multiple models to capture the variability in biological neurons
                                            and networks. Nat. Neurosci. 14, 133–138 (2011).
     models spanning brain and body.                                              
                                          33. Joesch, M., Schnell, B., Raghu, S. V., Reiff, D. F. & Borst, A. ON and OFF pathways in
                                            Drosophila motion vision. Nature 468, 300–304 (2010).
                                          34. Borst, A. & Helmstaedter, M. Common circuit design in fly and mammalian motion vision.
     Online content                         Nat. Neurosci. 18, 1067–1076 (2015).  
                                          35. Gjorgjieva, J., Sompolinsky, H. & Meister, M. Benefits of pathway splitting in sensory
     Any methods, additional references, Nature Portfolio reporting summa- coding. J. Neurosci. 34, 12127–12144 (2014).
     ries, source data, extended data, supplementary information, acknowl- 36. Strother, J. A., Nern, A. & Reiser, M. B. Direct observation of ON and OFF pathways in the
                                            Drosophila visual system. Curr. Biol. 24, 976–983 (2014).
     edgements, peer review information; details of author contributions          
                                          37. Maisak, M. S. et al. A directional tuning map of Drosophila elementary motion detectors.
     and competing interests; and statements of data and code availability Nature 500, 212–216 (2013).
     are available at https://doi.org/10.1038/s41586-024-07939-3. 38. Becht, E. et al. Dimensionality reduction for visualizing single-cell data using UMAP. Nat.
                                            Biotechnol. 37, 38–44 (2019).         
                                          39. Fisher, Y. E., Silies, M. & Clandinin, T. R. Orientation selectivity sharpens motion detection
     1. Rivera-Alba, M. et al. Wiring economy and volume exclusion determine neuronal in Drosophila. Neuron 88, 390–402 (2015).
       placement in the Drosophila brain. Curr. Biol. 21, 2000–2005 (2011). 40. Gruntman, E., Romani, S. & Reiser, M. B. The computation of directional selectivity in the
     2. Takemura, S. et al. Synaptic circuits and their variations within different columns in the Drosophila OFF motion pathway. eLife 8, e50706 (2019).
       visual system of Drosophila. Proc. Natl Acad. Sci. USA 112, 13711–13716 (2015). 41. Behnia, R., Clark, D. A., Carter, A. G., Clandinin, T. R. & Desplan, C. Processing properties
     3. Takemura, S. et al. The comprehensive connectome of a neural substrate for ‘ON’ motion of ON and OFF pathways for Drosophila motion detection. Nature 512, 427–430 (2014).
       detection in Drosophila. eLife 6, e24394 (2017). 42. Yang, H. H. et al. Subcellular imaging of voltage and calcium signals reveals neural
     4. Shinomiya, K. et al. Comparisons between the ON- and OFF-edge motion pathways in the processing in vivo. Cell 166, 245–257 (2016).
       Drosophila brain. eLife 8, e40025 (2019). 43. Arenz, A., Drews, M. S., Richter, F. G., Ammer, G. & Borst, A. The temporal tuning of the
     5. Shinomiya, K., Nern, A., Meinertzhagen, I. A., Plaza, S. M. & Reiser, M. B. Neuronal Drosophila motion detectors is determined by the dynamics of their input elements. Curr.
       circuits integrating visual motion information in Drosophila melanogaster. Curr. Biol. 32, Biol. 27, 929–944 (2017).
       3529–3544 (2022).                  44. Strother, J. A. et al. The emergence of directional selectivity in the visual motion pathway
     6. Matsliah, A. et al. Neuronal “parts list” and wiring diagram for a visual system. Preprint at of Drosophila. Neuron 94, 168–182 (2017).
       bioRxiv https://doi.org/10.1101/2023.10.12.562119 (2023). 45. Ramos-Traslosheros, G. & Silies, M. The physiological basis for contrast opponency in
     7. Dorkenwald, S. et al. Neuronal wiring diagram of an adult brain. Preprint at bioRxiv https:// motion computation in Drosophila. Nat. Commun. 12, 4987 (2021).
       doi.org/10.1101/2023.06.27.546656 (2023). 46. Ammer, G., Leonhardt, A., Bahl, A., Dickson, B. J. & Borst, A. Functional specialization of
     8. Schlegel, P. et al. Whole-brain annotation and multi-connectome cell typing quantifies neural input elements to the Drosophila ON motion detector. Curr. Biol. 25, 2247–2253
       circuit stereotypy in Drosophila. Preprint at bioRxiv https://doi.org/10.1101/2023.06.27. (2015).
       546055 (2023).                     47. Groschner, L. N., Malis, J. G., Zuidinga, B. & Borst, A. A biophysical account of multiplication
     9. Nern, A. et al. Connectome-driven neural inventory of a complete visual system. Preprint by a single neuron. Nature 603, 119–123 (2022).
       at bioRxiv https://doi.org/10.1101/2024.04.16.589741 (2024). 48. Strother, J. A. et al. Behavioral state modulates the ON visual motion pathway of Drosophila.
     10. Bargmann, C. I. & Marder, E. From the connectome to brain function. Nat. Methods 10, Proc. Natl Acad. Sci. USA 115, E102–E111 (2018).
       483–490 (2013).                    49. Tschopp, F. D., Reiser, M. B. & Turaga, S. C. A connectome based hexagonal lattice
     11. Goodfellow, I., Bengio, Y. & Courville, A. Deep Learning (MIT Press, 2016). convolutional network model of the Drosophila visual system. Preprint at https://arxiv.org/
     12. Butler, D.J., Wulff, J., Stanley, G.B. & Black, M.J. A naturalistic open source movie for abs/1806.04793 (2018).
       optical flow evaluation. In Computer Vision – ECCV 2012. ECCV 2012. Lecture Notes in 50. Mano, O., Creamer, M. S., Badwan, B. A. & Clark, D. A. Predicting individual neuron
       Computer Science Vol. 7577 (eds Fitzgibbon, A. et al.) 611–625 (Springer, 2012); https:// responses with anatomically constrained task optimization. Curr. Biol. 31, 4062–4075
       doi.org/10.1007/978-3-642-33783-3_44. (2021).                              
     13. Scheffer, L. K. & Meinertzhagen, I. A. A connectome is not enough–what is still needed to 51. Mi, L. et al. Connectome-constrained latent variable model of whole-brain neural activity.
       understand the brain of Drosophila? J. Exp. Biol. 224, jeb242740 (2021). In Proc. International Conference on Learning Representations https://openreview.net/
     14. Jabr, F. The connectome debate: Is mapping the mind of a worm worth it? SciAm https:// forum?id=CJzi3dRlJE- (2022).
       www.scientificamerican.com/article/c-elegans-connectome/ (2 October 2012). 52. Shiu, P. K. et al. A leaky integrate-and-fire computational model based on the connectome
     15. Hornik, K., Stinchcombe, M. & White, H. Multilayer feedforward networks are universal of the entire adult Drosophila brain reveals insights into sensorimotor processing. Preprint
       approximators. Neural Netw. 2, 359–366 (1989). at bioRxiv https://doi.org/10.1101/2023.05.02.539144 (2023).
     16. Raghu, M., Unterthiner, T., Kornblith, S., Zhang, C. & Dosovitskiy, A. Do vision transformers 53. Beiran, M. & Litwin-Kumar, A. Prediction of neural activity in connectome-constrained
       see like convolutional neural networks? Adv. Neural Inf. Process. Syst. 34, 12116–12128 recurrent networks. Preprint at bioRxiv https://doi.org/10.1101/2024.02.22.581667 (2024).
       (2021).                            54. Cowley, B. R. et al. Mapping model units to visual neurons reveals population code for
     17. Reichardt, W. in Sensory Communication (ed. Rosenblith, W. A.) Ch. 17 (MIT Press, 1961). social behaviour. Nature 629, 1100–1108 (2024).
     18. Barlow, H. B. & Levick, W. R. The mechanism of directionally selective units in rabbit’s 55. Zheng, Z. et al. A complete electron microscopy volume of the brain of adult Drosophila
       retina. J. Physiol. 178, 477–504 (1965). melanogaster. Cell 174, 730–743 (2018).
     19. Marder, E. Neuromodulation of neuronal circuits: back to the future. Neuron 76, 1–11 56. Winding, M. et al. The connectome of an insect brain. Science 379, eadd9330 (2023).
       (2012).                            57. Abbott, L. F. et al. The mind of a mouse. Cell 182, 1372–1376 (2020).
     20. Biswas, T. & Fitzgerald, J. E. Geometric framework to predict structure from function in 58. Warrington, A., Spencer, A. & Wood, F. The virtual patch clamp: imputing C. elegans
       neural networks. Phys. Rev. Res. 4, 023255 (2022). membrane potentials from calcium imaging. Preprint at https://arxiv.org/abs/1907.11075
     21. Paszke, A. et al. PyTorch: an imperative style, high-performance deep learning library. (2019).
       In Proc. 33rd International Conference on Neural Information Processing Systems (eds 59. Vaxenburg, R. et al. Whole-body simulation of realistic fruit fly locomotion with deep
       Wallach, H. et al.) 8026–8037 (Curran Associates, 2019). reinforcement learning. Preprint at bioRxiv https://doi.org/10.1101/2024.03.11.584515
     22. Yamins, D. L. K. et al. Performance-optimized hierarchical models predict neural responses (2024).
       in higher visual cortex. Proc. Natl Acad. Sci. USA 111, 8619–8624 (2014). 60. Lobato-Rios, V. et al. NeuroMechFly, a neuromechanical model of adult Drosophila
     23. Borst, A., Haag, J. & Mauss, A. S. How fly neurons compute the direction of visual motion. melanogaster. Nat. Methods 19, 620–627 (2022).
       J. Comp. Physiol. A 206, 109–124 (2020).                                   
     24. Currier, T. A., Pang, M. M. & Clandinin, T. R. Visual processing in the fly, from photoreceptors Publisher’s note Springer Nature remains neutral with regard to jurisdictional claims in
       to behavior. Genetics 224, iyad064 (2023). published maps and institutional affiliations.
     25. Fischbach, K. F. & Dittrich, A. P. M. The optic lobe of Drosophila melanogaster. I. A Golgi
       analysis of wild-type structure. Cell Tissue Res. 258, 441–475 (1989). Open Access This article is licensed under a Creative Commons Attribution
     26. Nern, A., Pfeiffer, B. D. & Rubin, G. M. Optimized tools for multicolor stochastic labeling 4.0 International License, which permits use, sharing, adaptation, distribution
       reveal diverse stereotyped cell arrangements in the fly visual system. Proc. Natl. Acad. and reproduction in any medium or format, as long as you give appropriate
       Sci. USA 112, E2967–E2976 (2015).  credit to the original author(s) and the source, provide a link to the Creative Commons licence,
     27. Gruntman, E., Romani, S. & Reiser, M. B. Simple integration of fast excitation and offset, and indicate if changes were made. The images or other third party material in this article are
       delayed inhibition computes directional selectivity in Drosophila. Nat. Neurosci. 21, included in the article’s Creative Commons licence, unless indicated otherwise in a credit line
       250–257 (2018).                    to the material. If material is not included in the article’s Creative Commons licence and your
     28. Meier, M. & Borst, A. Extreme compartmentalization in a Drosophila amacrine cell. Curr. intended use is not permitted by statutory regulation or exceeds the permitted use, you will
       Biol. 29, 1545–1550 (2019).        need to obtain permission directly from the copyright holder. To view a copy of this licence,
     29. Liu, T. X., Davoudian, P. A., Lizbinski, K. M. & Jeanne, J. M. Connectomic features underlying visit http://creativecommons.org/licenses/by/4.0/.
       diverse synaptic connection strengths and subcellular computation. Curr. Biol. 32,
       559–569 (2022).                    © The Author(s) 2024                    
                                                              Nature | www.nature.com | 9

                                                                                  
                                                                                  
     Article                                                                      
                                                                                  
     Methods                              superposition70), which we used for simulation and optimization of
                                          the model. We model columnar cell types, including retinal cells, lamina
     Construction of spatially invariant connectome from local monopolar and wide-field cells, medulla intrinsic cells, transmedullary
     reconstructions                      cells and T-shaped cells, as well as amacrine cells. The model comprises
     We built a computational model of the fly visual system that is con- synapses from all neuropils and downstream- and upstream-projecting
     sistent with available connectome data1–5, has biophysically plausi- connections from the retina, lamina and medulla.
     ble neural dynamics, and can be computationally trained to solve an          
     ethologically relevant behavioural task, namely the estimation of optic Neuronal dynamics
     flow. To achieve this, we developed algorithms to blend annotations In detail, we simulated point neurons with voltages V of a postsynap-
                                                                     i            
     from two separate datasets by transforming, sanitizing, combining tic neuron i, belonging to cell type t using threshold-linear dynam-
                                                             i                    
     and pruning the raw datasets into a coherent connectome spanning all ics, mathematically equivalent to commonly used formulations of
     neuropils of the optic lobe (Supplementary Note 1 and Supplementary firing-rate models71
     Data files 1–3).                                                             
       The original data stem from focused ion beam scanning electron τ tiV i̇=−V i+∑s ij+V tre ist+e i. (1)
     microscopy datasets from the FlyEM project at Janelia Research j             
     Campus. The FIB-25 dataset volume comprises seven medulla col-               
     umns and the FIB-19 dataset volume comprises the entire optic lobe Neurons of the same cell type share time constants, τ, and resting
     and, in particular, detailed connectivity information for inputs to potentials, Vrest. Dynamic visual stimuli were delivered as
                                                                      eti         
                                                                       xternal input
     both the T4 and T5 pathways2–4. The data available to us consisted currents e tot i the photoreceptor (R1–R8), for all other cell types, e = 0.
                                               i                           i      
     of 1,801 neurons, 702 neurons from FIB-25 and 1,099 neurons from In our model, instantaneous graded synaptic release from presynaptic
     FIB-19. For about 830 neurons, the visual column was known from neuron j to postsynaptic neuron i is described by
     hand annotation. These served as reference positions. Of the 830             
     reference positions, 722 belong to neuron types selected for simula- s ij=w ijf(V j)=α titjσ titjN titjΔuΔvf(V j), (2)
     tion. None of the T5 cells, whose directional selectivity we aimed to        
     elucidate, was annotated. We therefore built an automated, proba- comprising the anatomical filters in terms of the synapse count from
     bilistic expectation maximization algorithm that takes synaptic con- electron microscopy reconstruction, N , at the offset location
                                                               titjΔuΔv           
     nection statistics, projected synapse centre-of-mass clusters and Δu=u−u and Δv=v−v in the hexagonal lattice between two types
                                             i j     i j                          
     existing column annotations into account. We verified the quality of of cells, t and t, and further characterized by a sign, σ ∈{−1,+1}, and
                                               i  j                  titj         
     our reconstruction as described in Supplementary Note 1. Only the a non-negative scaling factor, α .
                                                          titj                    
     neurons consistently annotated with both 100% and 90% of reference The synapse model entails a trainable non-negative scaling factor
     positions used were counted to estimate the number of synapses per filter that is initialized as
     between cell types and columns, to prune neuron offsets with low             
                                                            0.01                  
     confidences.                                      α  =     ,                 
       Synaptic signs for most cell types were predicted on the basis             
                                                        ti,tj ⟨N ti,tj⟩           
                                                             Δu,Δv                
     of known expression of neurotransmitter markers (primarily the               
     cell-type-specific transcriptomics data from ref. 30). For a minority with the denominator describing the average synapse count of the
     of cell types included in the model, no experimental data on transmit- filter. Synapse counts, N from the connectome, and signs, σ
                                                       titjΔuΔv             titj  
     ter phenotypes were available. For these neurons, we used guesses of from the neurotransmitter and receptor profiling, were kept fixed. The
     plausible transmitter phenotypes. To derive predicted synaptic signs scaling factor was clamped during training to remain non-negative.
     from transmitter phenotypes, we assigned the output of histaminergic, Moreover, at initialization, the resting potentials were sampled from
     GABAergic and glutamatergic neurons as hyperpolarizing and the out- a Gaussian distribution
     put of cholinergic neurons as depolarizing. In a few cases, we further       
     modified these predictions on the basis of distinct known patterns V tr iest~N(μ Vrest,σ V2 rest)
     of neurotransmitter receptor expression (see ref. 30 for details). For       
     example, output from R8 photoreceptor neurons, predicted to release with mean μ =0.5 (a.u.) and variance σ2 =0.05 (a.u.). The time
                                                 Vrest          Vrest             
     both acetylcholine and histamine, was treated as hyperpolarizing or constants were initialized at τ =50ms. The 50 task-optimized DMNs
                                                         ti                       
     depolarizing, respectively, depending on whether a target cell type is were initialized with the same parameter values. During training, in
     known to express the histamine receptor gene ort (which encodes a Euler integration of the dynamics, we clamped the time constants as
     histamine-gated chloride channel).   τ=max(τ,Δt), so that they remain above the integration time step Δt
                                           i   i                                  
                                          at all times.                           
     Representing the model as a hexagonal convolutional neural In total, the model comprises 45,669 neurons and 1,513,231 syn-
     network                              apses, across two-dimensional (2D) hexagonal arrays 31 columns
     Our end-to-end differentiable61 DMN model of the fly visual system across. The number of free parameters is independent of the number
     can be interpreted as a continuous-time neural ordinary differential of columns: 65 resting potentials, 65 membrane time constants, 604
     equation62 with a deep convolutional recurrent neural network63 scaling factors; and connectome-determined parameters: 604 signs
     architecture that is trained to perform a computer vision task using and 2,355 synapse counts. Thus, the number of free parameters in the
     backpropagation through time64,65. Our goal was to optimize a simu- visual system model is 734.
     lation of the fly visual system to perform a complex visual informa- In the absence of connectome measurements, the number of
     tion processing task using optimization methods from deep learning. parameters to be estimated is much larger. With T = 65 cell types
     One hallmark of visual systems that has been widely exploited in such (counting CT1 twice for the compartments in the medulla and
     tasks is their convolutional nature66–69 (that is, the fact that the same lobula) and C = 721 cells per type for simplicity, the number of cells
     computations are applied to each pixel of the visual input). To model in our model would be TC = 46,865. Assuming a recurrent neural net-
     the hexagonal arrangement of photoreceptors in the fly retina, we work with completely unconstrained connectivity and simple dynam-
     developed a hexagonal convolutional neural network (CNN) in the ics τV=−V+∑ w f(V)+Vrest, we would have to find (TC)2+2(TC)=
                                            i i i j ij j i                        
     widely used deep learning framework PyTorch21 (ignoring neuronal 2,196,421,955 free parameters. Assuming a convolutional recurrent

                                                                                  
                                                                                  
                                                                                  
                                                                                  
     neural network with shared filters between cells of the same post- integration for a given input X results in simulated sequences of volt-
     synaptic type, shared time constants and shared resting potentials, ages V∈RN,TC, with T
                                                     C                            
                                                      being the total number of cells. The subset of
     the amount of parameters reduces markedly to T2C+2T=3,046,355. voltages, V out∈RN,D,C, of the D cell types in the black rectangle in Fig. 1g
     Further assuming the same convolutional recurrent neural network was passed to a decoding network. For decoding, the voltage was rec-
     but additionally that convolutional filters are constrained to F = 5 tified to avoid the network finding biologically implausible solutions
     visual columns (that is, the number of presynaptic input columns in by encoding in negative dynamic ranges. Furthermore, it was mapped
     the hexagonal lattice is P=3F(F+1)+1), the amount of parameters to Cartesian coordinates to apply PyTorch’s standard spatial convolu-
     reduces to T2P+2T=384,605. Assuming as in our connectome that tion layers for decoding and on each time step independently. In the
     only Q = 604 connections between cell types exist, this reduces the decoding network, one layer implementing spatial convolution, batch
     number of parameters further to QP+2T=55,185. Instead of para- normalization, softplus activation and dropout, followed by one layer
     metrizing each individual synapse strength, we assume that synapse of spatial convolution, transforms the D feature maps into the 2D rep-
     strength is proportional to synapse count from the connectome times resentation of the estimated optic flow, Yˆ∈RN,2,C.
     a scalar for each filter, reducing the number of parameters to Using stochastic gradient descent with adaptive moment estimation
     Q+2T=734 while providing enough capacity for the DMNs to yield (β = 0.9, β = 0.999, learning rate decreased from 5 × 10−5 to 5 × 10−6 in
                                           1   2                                  
     realistic tuning to solve the task.  ten steps over iterations, batch size of four) and the automatic gradient
                                          calculation of the fully differentiable pipeline, we optimized the bio-
     Convolutions using scatter and gather operations. For training the physical parameters through backpropagation through time such that
     network, we compiled the convolutional architecture specified by the they minimize the L2-norm between the predicted optic flow, Yˆ, and
     connectome and the sign constraints to a graph representation con- the ground-truth optic flow, Y:
     taining: a collection of parameter buffers shared across neurons and/        
     or connections; a collection of corresponding index buffers indicating L(Y,Ŷ)= Y−Ŷ .
     where the parameters relevant to a given neuron or connection can be         
     found in the parameter buffers; and a list of pairs (presynaptic neuron We additionally optimized the shared resting potentials for 150,000
     index, postsynaptic neuron index) denoting connectivity. This allowed iterations, using stochastic gradient descent without momentum, with
     us to efficiently simulate the network dynamics through Euler integra- respect to a regularization function of the time-averaged responses
     tion using a small number of element-wise, scatter and gather opera- to naturalistic stimuli of the central column cell of each cell type, t ,
                                                                           central
     tions at each time step. We found that this is more efficient than using a to encourage configurations of resting potentials that lead to non-zero
     single convolution operation or performing a separate convolution for and non-exploding activity in all neurons in the network. We weighted
     each cell type as each cell type has its own receptive field—some much these terms independently with γ = 1, encouraging activity greater than
     larger than others—and the number of cells per type is relatively small. a, and δ = 0.01, encouraging activity less than a. We chose λ =0.1 and
                                                                        V         
                                          a = 5 in arbitrary units. With B being the batch size and T being the num-
     Optic flow task                      ber of all cell types, the regularizer is
     Model training. An optic flow field for a video sequence consists of a       
     2 thD                                                                        
       e                                                                          
       v mec at go nr                                                             
          i                                                                       
           f ti ue dld                                                            
             e                                                                    
             f ao nr                                                              
               d                                                                  
               e a dc irh                                                         
                 e                                                                
                  f cr ta im one o. T                                             
                     f                                                            
                      h the                                                       
                       e                                                          
                       2 aD                                                       
                         p                                                        
                         v pe ac rt eo nr                                         
                            t                                                     
                             a lt                                                 
                             o                                                    
                              e ca ac                                             
                               l                                                  
                               h                                                  
                                m                                                 
                                p oix ve el                                       
                                   m                                              
                                   re ep nr te os fe tn ht es                     
                                             R(V)=                                
                                                 λ                                
                                                  V ∑ ∑                           
                                                        γ(V−a)2, if V= N1 ∑    
                                                                  n               
                                                                   V btcentral[n]≤a
     brightness pattern in an image.             BT b tcentral δ(V−a)2, if V>a. 
       We frame the training objective as a regression task                       
                                           We regularly checkpointed the error measure L(Y,Yˆ) averaged across
             Yˆ[n]=Decoder(DMN(X[0],...,X[n])),                                   
                                          a held-out validation set of Sintel video clips. Models generalized on
                                          optic flow computation after about 250,000 iterations, yielding func-
       with Yˆ being the optic flow prediction, and X being the visual stimu- tional candidates for our fruit fly visual system models that we analysed
     lus sequence from the Sintel dataset, both sampled to a regular hex- with respect to their tuning properties.
     agonal lattice of 721 columns. With the objective to minimize the square     
     error loss between predicted optic flow and target optic flow fields, Task-optimization dataset. We optimized the network on 23 sequences
     we jointly optimized the parameters of both the decoder and the visual from the publicly available computer-animated film Sintel12. The
     system network model described above. sequences have 20–50 frames, at a frame rate of 24 frames per second
       In detail, for training the network, we added randomly augmented, and a pixel resolution of 1,024 × 436. The dataset provides optical flow
     greyscaled video sequences from the Sintel dataset sampled to a reg- in pixel space for each frame after the first of each sequence. As the
     ular hexagonal lattice of 721 columns to the voltage of the 8 photore- integration time steps we use are faster than the actual sampling rate
     ceptor cell types (Fig. 1f and equation (1)). We denote a sample from a of the sequences, we resample input frames accordingly over time and
     minibatch of video sequences as X∈RN,C, with N being the number of interpolate the optic flow.
     time steps, and C being the number of photoreceptor columns. The             
     dynamic range of the input lies between 0 and 1. Input sequences dur- Fly-eye rendering. We first transformed the RGB pixel values of the
     ing training entailed 19 consecutive frames drawn randomly from the visual stimulus to normalized greyscale between 0 and 1. We translated
     dataset and resampled to match the integration rate. At the original Cartesian frames into receptor activations by placing simulated pho-
     frame rate of 24 Hz, this corresponds to a simulation of 792 ms. We did toreceptors in a 2D hexagonal array in pixel space, 31 columns across
     not find that an integration time step smaller than 20 ms (that is, a resulting in 721 columns in total, spaced 13 pixels apart. The transduced
     frame rate of 50 Hz after resampling) yielded qualitatively superior luminance at each photoreceptor is the greyscale mean value in the
     task performance or more realistic tuning predictions. We interpolated 13 × 13-pixel region surrounding it.
     the target optic flow in time to 50 Hz temporal resolution. To increase      
     the amount of training data for better generalization, we augmented Augmentation. We used: random flips of input and target across one
     input and target sequences as described further below. At the start of of the three principal axes of the hexagonal lattice; random rotation
     each epoch, we computed an initial state of the network’s voltages after of input and target around its six-fold rotation axis; adding element-
     500 ms of grey stimulus presentation to initialize the network at a wise Gaussian noise with mean zero and variance σ =0.08 to the
                                                                      n           
     steady state for each minibatch during that epoch. The network input X (then clamped at 0); random adjustments of contrasts,

                                                                                  
                                                                                  
     Article                                                                      
                                                                                  
     logcN(0,σ2=0.04), and brightness, bN(0,σ2=0.01), of the input DMN type. The task-optimized parameters in each case are highlighted
            c                 b                                                   
     with X′=c(X−0.5)+0.5+cb.             using bold symbols. We randomly initialized the models with
       In addition, we ‘strided’ the fly-eye rendering across the rectangu- m ti,tj,w ti,tjN( 0, n2 in) , in which n
                                                           in                     
                                                            is the number of cell connections
     lar raw frames in width, subsampling multiple scenes from each. We and m is non-negative, and σ ∈{−1,1} with equal probability.
     ensured that such subsamples from the same scene were not distributed        
                                                         tj                       
     across training and validation sets. Input sequences in chunks of 19 con- Unconstrained CNN. We trained unconstrained, fully convolutional
     secutive frames were drawn randomly in time from the full sequences. neural networks on the same dataset and task to provide an estimate of
                                          a lower bound for the task error of the DMN. Optic flow was predicted
     Black-box decoding network. The decoding network is feedforward, by the CNN from two consecutive frames
     convolutional and has no temporal structure. Aspects of the architec-        
     ture are explained in the section entitled Model training. The spatial       
                                                     Yˆ[n]=CNN(X[n],X[n−1]).      
     convolutions have a filter size of 5 × 5. The first layer transforms the     
     D = 34 feature maps to an eight-channel intermediate representa- with the original frame rate of the Sintel film. We chose 5 layers for the
     tion, which is further translated by an additional convolutional layer CNN with 32, 92, 136, 8 and 2 channels, respectively, and kernel size 5
     to a three-channel intermediate representation of optic flow. The for all but the first layer, for which the kernel size is 1. Each layer per-
     third channel is used as shared normalization of each coordinate of forms a convolution, batch normalization and exponential linear unit
     the remaining 2D flow prediction. The decoder uses PyTorch-native activation, except the last layer, which performs only a convolution.
     implementations for 2D convolutions, batch normalization, softplus We optimized an ensemble of 5 unconstrained CNNs with 414,666 free
     activation and dropout. We initialized its filter weights homogene- parameters each using the same loss function, L(Y,Yˆ), as for the DMN.
     ously at 0.001.                      We used the same dataset (that is, hexagonal sequences and augmen-
                                          tations from Sintel) for training and validating the CNN as that used for
     Model characterization               training and validating the DMN, enabled by two custom modules
     Task error. To rank models on the basis of their task performance, we mapping from the hexagonal lattice to a Cartesian map and back.
     computed the standard optic flow metric of average end-to-end point          
     error (EPE)72, which calculates the average over all time steps and pixels Circular flash stimuli. To evaluate the contrast selectivity of cell
     (that is, here columns) of the error types in task-optimized models, we simulated responses of each
                                          DMN to circular flashes. The networks were initialized at an approxi-
               1                                                                  
        EPE(Y,Yˆ)= ∑∑ (y [n]−yˆ [n])2+(y [n]−yˆ [n])2 mate steady state after 1 s of grey-screen stimulation. Afterwards the
              NC     1c  1c   2c  2c                                              
                 n c                      flashes were presented for 1 s. The flashes with a radius of 6 columns
                                          were ON (intensity I = 1) or OFF (I = 0) on a grey (I = 0.5) background.
     between predicted optic flow and ground-truth optic flow and averaged We integrated the network dynamics with an integration time step of
     across the held-out validation set of Sintel sequences. 5 ms. We recorded the responses of the modelled cells in the central
                                          columns to compute the FRI.             
     Importance of task optimization and connectome constraints.                  
     We generated DMNs with different constraints to assess their relative FRI. To derive the contrast selectivity of a cell type, t, we computed the
                                                                    i             
     importance for predicting tuning properties. First, we studied the FRI as    
     importance of task optimization of DMN parameters. We cre-                   
     ated 50 DMNs with random Gaussian-distributed parameters, and                
                                                    FRI                           
                                                      =rp tce ea ntk ral(I=1)−r tp ce ea ntk ral(I=0)
     task-optimized only their decoding network, to obtain baseline values ti rpeak (I=1)+rpeak (I=0)
     for both the task error and the accuracy of predicting tuning curves         
                                                        tcentral tcentral         
     without task optimization of the DMN. from the non-negative activity         
       In the full DMN, we constrained single synapses by connectome              
     cell-type connectivity, cell connectivity, synapse counts and synapse r tp ce ea ntk ral(I)=m naxV tcentral[n](I)+|m n,i InV tcentral[n](I)|,
     signs (equation (2)) and task-optimized the non-negative type-to-type        
     unitary synapse scaling factor α . Next, we trained five additional from voltage responses V [n](I) to circular flash stimuli of intensi-
                      ti,tj                            tcentral                   
     task-optimized DMNs with different connectome constraints (Fig. 2d ties I∈{0,1} lasting for 1 s after 1 s of grey stimulus. We note that our
     and Extended Data Fig. 2a–d).        index quantifies whether the cell depolarizes to ON- or to OFF-stimuli.
       In these five additional types of DMN, we additionally task-optimized However, cells such as R1–R8, L1 and L2 can be unrectified (that is, sen-
     the terms in bold, rather than using connectome measurements, related sitive to both light increments and light decrements), which is not
     to synaptic currents from a presynaptic cell j to a postsynaptic captured by our index.
     cell i: known single-cell connectivity, unknown synapse count: For the P values reported in the results, we carried out a binomial
     w =σ m    , in which m is non-negative; known cell- test with probability of correct prediction 0.5 (H0) or greater (H1) to
      ij ti,tj ti,tj,Δu,Δv ti,tj,Δu,Δv                                            
     type connectivity, unknown single-cell connectivity and synapse test whether both the median FRI from the DMN ensemble and the
     counts: w =σ m      (that is, for all connected cell task-optimal model can predict the contrast preferences. Additionally,
          i,j ti,tj ti,tj,−3<Δu,Δv,Δu+Δv<3                                        
     types, a connection weight was learned for all cells up to a distance of we found for each individual cell type across 50 DMNs that predictions
     three columns in hexagonal coordinates, with known signs); known for 29 out of 31 cell types are significant (P < 0.05, binomial).
     single-cell connectivity and synapse counts, but unknown synapse             
     signs: w =α σ N (that is, connection weights were fixed by Moving-edge stimuli. To predict the motion sensitivity of each cell
         i,j ti,tj tj ti,tj,Δu,Δv                                                 
     measurements, but signs optimized); known single-cell connectivity, type in task-constrained DMNs, we simulated the response of each
     but unknown synapse signs and synapse counts: w =w , (that network, initialized at an approximate steady state after 1 s of grey-
                               i,j ti,tj,Δu,Δv                                    
     is, all non-zero connection weights were optimized, including their screen stimulation, to custom generated edges moving to 12 different
     signs); or known cell-type connectivity, unknown single-cell connectiv- directions, θ∈[0°,30°,60°,90°,120°,150°,180°,210°,240°,270°,
     ity, synapse counts and synapse signs: w =w (that 300°,330°]. We integrated the network dynamics with an integration
                          i,j ti,tj,−3<Δu,Δv,Δu+Δv<3                              
     is, for all connected cell types, a connection weight and sign was learned time step of 5 ms. ON-edges (I = 1) or OFF-edges (I = 0) moved on a grey
     for all cells up to distance of three columns). We trained 50 models per (I = 0.5) background. Their movement ranged from −13.5° to 13.5°

                                                                                  
                                                                                  
                                                                                  
                                                                                  
     visual angle and we moved them at six different speeds, ranging symmetric inputs. From p(d*|t ), we derived the threshold
                                                            sym                   
     from 13.92° s−1 to 145° s−1 (S∈[13.92°s−1,27.84°s−1,56.26°s−1,75.4°s−1, d =0.357 as the 99% quantile of the random variable d*, meaning
                                           thresh                                 
     110.2°s−1,145.0°s−1]). In Fig. 2d, we report the correlation between that the probability that a realization of d*>d is less than 1% for
                                                                  thresh          
     predicted motion-tuning curves to the single experimentally measured cell types with symmetric inputs. To determine whether an asymmet-
     tuning curve. We take the maximum correlation across six investi- ric cell type counts as direction selective, we tested whether syntheti-
     gated speeds to make the correlation measure robust to potential cally measuring direction selectivity larger than d in that cell type
                                                                   thresh         
     variations in preferred speeds.      is binomial with probability 0.1 (H0) or greater (H1). We identified 12
                                          cell types with asymmetric inputs (T4a, T4b, T4c, T4d, T5a, T5b, T5c,
     DSI. We computed a DSI73 of a particular type t as T5d, TmY3, TmY4, TmY5a and TmY18) as direction selective (P < 0.05)
                             i                                                    
                                          from our models, and 7 cell types with asymmetric inputs to not count
            DSI ti(I)= S1 S∑                                                      
                   ∈S                                                             
                     ∑ θ m∈ IΘ                                                    
                       ∈a                                                         
                       Ir xtp c ∑e ea n θtk ra rl( tpI c,                         
                           e ea                                                   
                           nS                                                     
                            tk                                                    
                            r, alθ (I) ,e Sx ,p θ( )iθ) a E ass x                 
                                           y                                      
                                            td mei nr me dc e et tdio             
                                               r                                  
                                               iDn ca is nte a pl e F uc i tgt si . )v .5e a ( sT r2 e, fT e2 ra e, n T c3 e, fT om r c3 e, T llm ty4 p, eT sm wY it1 h4 sa yn md mTm etY r1 i5 c; a s ne de
     from rectified peak voltages         Uniform manifold approximation and projection and clustering.
                                          We first simulated central column responses to naturalistic scenes
              r tp ce ea ntk ral(I,S,θ)=m naxV t+ central[n](I,S,θ), (24 Hz Sintel video clips from the full augmented dataset) with an
                                          integration time step of 10 ms. We clustered models in feature space
     elicited from moving-edge stimuli. We rectify the voltage to quantify of concatenated central column responses and sample dimension.
     the tuning of the effective output of the cell, and to avoid the denom- Next, we computed a nonlinear dimensionality reduction to two
     inator becoming zero. We parameterized movement angle θ∈Θ, inten- dimensions using the UMAP (uniform manifold approximation and
     sities I∈I, and speeds S∈S of the moving edges. To take the response projection) algorithm, and fitted Gaussian mixtures of 2 to 5 com-
     magnitudes into account for comparing the DSI for ON- and for ponents, with the number of components that minimize the Bayes-
     OFF-edges, we normalized by the maximum over both intensities in ian information criterion, using the Python libraries umap-learn and
     the denominator. To take different speeds into account, we averaged scikit-learn38,74.
     over S.                                                                      
                                          Single-ommatidium flashes. To derive spatio-temporal recep-
     Normalization of model neural activity for averaging across models tive fields of cells, we simulated the response of each network to
     in a cluster. Threshold-linear networks have arbitrary units for the single-ommatidium flashes. Flashes were ON (I = 1) or OFF (I = 0) on a
     voltages and currents. Therefore, we normalized the neural activity grey (I = 0.5) background and presented for [5, 20, 50, 100, 200, 300] ms
     before averaging the neural activity predictions from different models. after 2 s of grey-screen stimulation and followed by 5 s of grey-screen
     For a single cell or cell type t, we first divided responses (voltages or stimulation.
     rectified voltages) by the root mean square across the cell’s responses      
     to the naturalistic stimuli:         Spatio-temporal, spatial and temporal receptive fields. We derived
                                          the spatio-temporal receptive field (STRF) of a cell type t as the
                                                                          i       
                        r[n]                                                      
                 r∣∣⋅∣∣1[n]= t ,         baseline-subtracted responses of the central column cell to single-
                  t   ∣∣ S1 NR tnat. ∣∣                                           
                            2                                                     
                                          ommatidium flashes J(u,v) at ommatidium locations (u,v):
     in which R tnat.∈RS,N is the cell’s response vector to S sequences from STRF tcentral[n](u,v)=V tcentral[n](J(u,v))−V tcentral[n=0](J(u,v)).
     the Sintel dataset with N time steps and r[n] is the cell’s response to      
                          t                                                       
     any stimuli. This normalization makes averages (Fig. 4a,b,d–e and We derived spatial receptive fields (SRFs) from the responses to
     Extended Data Figs. 4, 7, 8, and 9a,b) independent to variation in the flashes (20 ms in Fig. 4d) J(u,v) at the point in time at which the
     scale of neural activity from model to model. We normalized input response to the central ommatidium impulse is at its extremum:
     currents equivalently (Fig. 4b and Extended Data Figs. 4, 7, and 8) by       
                                              SRF(u,v)=STRF(n=argmax |STRF[n](0,0)|,u,v).
     the same normalization factor. We exclude solutions for which the n          
     denominator becomes zero.                                                    
                                           We derive temporal receptive fields (TRFs) from the response to a
     Determining whether a cell type with asymmetric inputs counts flash J(0,0) at the central ommatidium: TRF[n]=STRF[n](0,0). For
     as direction selective. We counted a cell type as direction selective averaging receptive fields across multiple models, we first normalize
     if the DSIs from its synthetic measurements were larger than 99% of the voltages as described above.
     DSIs from non-motion selective cell types (that is, those with sym-          
     metric filters). We note, however, that estimates of the spatial asym- Maximally excitatory naturalistic and artificial stimuli. First, we
     metry of connectivity from existing connectome reconstructions can found the naturalistic maximally excitatory stimulus, X*, by identifying
     be noisy.                            the Sintel video clip, X, from the full dataset with geometric augmenta-
       For deriving the 99% threshold, we first defined a distribution tions that elicited the highest possible response in the central column
      p(d*|t ) over the DSI for non-direction-selective cells, from peak cell of a particular cell type in our models.
         sym                                                                      
     responses to moving edges of cell types with symmetric inputs, t .           
                                       sym            X*=argmaxV (X).             
     We computed that distribution numerically by sampling   tcentral             
                                                         X∈Sintel                 
                d*=                                                               
                  ∑ θ*r tp ce ea ntk ral(I,S,θ*)expiθ                             
                                          to                                      
                                           N yie ex ldt,                          
                                              X                                   
                                              w ′,e                               
                                               c                                  
                                                r ae pg tu ul ra ir ni gz e od    
                                                     n                            
                                                      lt yh te                    
                                                       h                          
                                                        n ea st tu imra uli ls ut sic
                                                             in                   
                                                              m foa rx mim aa til oly
                                                                   n              
                                                                   e wx ic ti ht ia nt o thry
                                                                        e         
                                                                         s reti cm epu tlu ivs e,
                    ∑ rpeak(I,S,θ)                                                
                     θ tcentral           field of the cell, with the objective to minimize
     for 100 independent permutations of the angle θ*. We independently 2 1 2     
                                            L(X′)=∑ V (X*)[n]−V (X′)[n] + ∑ X′[n,c]−0.5 .
     computed d* for all stimulus conditions, models and cell types with tcentral tcentral C
                                                n                  c              

                                                                                  
                                                                                  
     Article                                                                      
                                                                                  
       The first summand preserves the central response to X*, and the with multiplicative noise to imitate spurious measurements. We used
     second regularizes the irrelevant portions of the stimulus outside the σ=0.5 for the main results. Weight magnitudes were initialized at the
     receptive field to grey (I = 0.5).   measurement, m͠ , and task-optimized on MNIST with the additional
                                                   ij                             
       In addition, we computed artificial maximally excitatory stimuli75. objective to minimize the squared distance between optimized and
                                          measured weight magnitudes, m͠ (L2 constraint, Gaussian weight
                                                            ij                    
     Model selection. To describe the most data-consistent motion tuning magnitude prior centred around the simulated network’s initialization).
     mechanisms predicted by the ensemble at the level of single-cell cur- We weighted the L2 constraint ten times higher than the cross-entropy
     rents, for Extended Data Figs. 4, 7 and 8, we automatically selected objective to keep weight magnitudes of the simulated networks close
     those models from the ensemble with tuning matching to empirical to the noisy connectome measurements. Resting potentials, Vrest, were
                                                                         i        
     data. Specifically, we selected models with correct contrast tuning in again initialized randomly and task-optimized.
     the respective target cells and their inputs (Fig. 4c and Extended           
     Data Fig. 3d), with the DSI larger than the threshold d* derived above, Measuring ground-truth-simulated network similarity. Ground-
     and with a correctly predicted preferred direction (45° acceptance truth-simulated network similarity was measured by calculating the
     angle, assuming 225° for TmY3).      median Pearson’s correlation of tuning responses (rectified voltages)
                                          of corresponding neurons in the ground-truth-simulated network
     Training synthetic connectomes       pair. In each of the 6 hidden layers, N = 100 randomly sampled neurons
     Training feedforward synthetic ground-truth connectome net- were used for comparison. Response tuning was measured over input
     works. Sparsified feedforward neural networks with six hidden layers stimuli from the MNIST test set (N = 10,000 images). Results are medi-
     (linear transformations sandwiched between rectifications) with equal ans over all hidden layers and over 25 ground-truth-simulation network
     number of neurons in each hidden layer functioned as ground-truth pairs.     
     connectome networks. The main results describe networks with 128             
     neurons per hidden layer. We interpret the individual units as neurons Reporting summary
     with voltage                         Further information on research design is available in the Nature Port-
                                          folio Reporting Summary linked to this article.
             V=∑s +Vrest=∑σc m f(V)+Vrest,                                        
              i  ij i   j ij ij j i                                               
                j     j                                                           
                                          Data availability                       
     with presynaptic inputs s and resting potentials Vrest. The Data, trained models and interactive notebooks are available at https://
                     ij             i                                             
     connectome-constrained synapse strength, w, is characterized by the www.github.com/TuragaLab/flyvis.
                            ij                                                    
     adjacency matrix c , the signs σ, and the non-negative weight magni-         
               ij    j                                                            
     tudes m . c =1 if the connection exists, else c =0. To respect Dale’s        
          ij ij              ij                                                   
                                          Code availability                       
     law, the signs were tied to the presynaptic identity, j.                     
       We identified the parameters σ, m and Vrest by task optimization Code is available at https://www.github.com/TuragaLab/flyvis.
                       j ij i                                                     
     on handwritten digit classification (Modified National Institute of          
     Standards and Technology (MNIST) database)76. We determined adja-            
     cency matrices, c , for a given connectivity percentage using an 61. AlQuraishi, M. & Sorger, P. K. Differentiable biology: using deep learning for biophysics-
               ij                                                                 
     iterative local pruning technique, the lottery ticket hypothesis algo- based and data-driven modeling of molecular mechanisms. Nat. Methods 18, 1169–1180
                                            (2021).                               
     rithm77. The algorithm decreases the connectivity percentage of the 62. Chen, R. T. Q., Rubanova, Y., Bettencourt, J. & Duvenaud, D. K. Neural ordinary differential
     ground-truth connectome networks while maintaining high task equations. In Proc. Advances in Neural Information Processing Systems Vol. 31 (eds
     accuracy.                              Bengio, S. et al.) 6571–6583 (Curran Associates, 2018).
                                          63. Shi, X. et al. Convolutional LSTM network: a machine learning approach for precipitation
       We optimized the ground-truth connectome networks and all simu- nowcasting. In Proc. Advances in Neural Information Processing Systems Vol. 28 (eds
     lated networks described below in PyTorch with stochastic gradient Cortes, C. et al.) 802–810 (Curran Associates, 2015).
                                          64. Rumelhart, D. E., Hinton, G. E. & Williams, R. J. Learning representations by back-
     descent with adaptive moment estimation (ADAM with AMSGrad),                 
                                            propagating errors. Nature 323, 533–536 (1986).
     learning rate 0.001, batch size 500, and an exponentially decaying 65. Werbos, P. J. Backpropagation through time: what it does and how to do it. Proc. IEEE 78,
     learning rate decay factor of 0.5 per epoch. To constrain the weight 1550–1560 (1990).
                                          66. Fukushima, K. & Miyake, S. in Competition and Cooperation in Neural Nets (eds Amari, S.
     magnitudes to stay non-negative, we clamped the values at zero after         
                                            et al.) 267–285 (Springer, 1982).     
     each optimization step (projected gradient descent). The parameters 67. LeCun, Y. et al. Backpropagation applied to handwritten zip code recognition. Neural
     after convergence minimize the cross-entropy loss between the pre- Comput. 1, 541–551 (1989).
                                          68. Riesenhuber, M. & Poggio, T. Hierarchical models of object recognition in cortex. Nat.
     dicted and the ground-truth classes of the handwritten digits. More          
                                            Neurosci. 2, 1019–1025 (1999).        
     implementation detail is available in Supplementary Note 5. 69. Krizhevsky, A., Sutskever, I. & Hinton, G. E. ImageNet classification with deep
                                            convolutional neural networks. In Proc. Advances in Neural Information Processing
                                            Systems (eds Pereira, F. et al.) 1097–1105 (Curran Associates, 2012).
     Simulated networks with known connectivity and unknown                       
                                          70. Braitenberg, V. Patterns of projection in the visual system of the fly. I. Retina-lamina
     strength. Simulated networks inherited connectivity, c ij, and synapse projections. Exp. Brain Res. 3, 271–298 (1967).
     signs, σ, from their respective ground-truth connectome networks. 71. Miller, K. D. & Fumarola, F. Mathematical equivalence of two common forms of firing rate
         j                                  models of neural networks. Neural Comput. 24, 25–31 (2012).
     In simulated networks, signs and connectivity were held fixed. Weight        
                                          72. Dosovitskiy, A. et al. FlowNet: Learning optical flow with convolutional networks.
     magnitudes, m ij, and resting potentials, V irest, were initialized random- In Proc. IEEE International Conference on Computer Vision 2758–2766 (IEEE,
     ly and task-optimized. Just like ground-truth connectome networks, 2015).    
                                          73. Mazurek, M., Kager, M. & Hooser, S. D. V. Robust quantification of orientation selectivity
     simulated networks were trained on the MNIST handwritten digit clas-         
                                            and direction selectivity. Front. Neural Circuits 8, 92 (2014).
     sification task until convergence.   74. Pedregosa, F. et al. Scikit-learn: machine learning in Python. J. Mach. Learn. Res. 12,
                                            2825–2830 (2011).                     
                                          75. Walker, E. Y. et al. Inception loops discover what excites neurons most using deep
     Simulated networks with known connectivity and known strength.               
                                            predictive models. Nat. Neurosci. 22, 2060–2065 (2019).
     Alternatively, we imitate measurements of synaptic counts from the 76. LeCun, Y., Cortes, C., & Burges, C. J. The MNIST database of handwritten digits.
     ground-truth weight magnitudes:        http://yann.lecun.com/exdb/mnist (accessed 4 September 2024).
                                          77. Frankle, J. & Carbin, M. The lottery ticket hypothesis: finding sparse, trainable neural
                                            networks. In Proc. International Conference on Learning Representations https://
               m͠ =m ϵ withϵ U(1−σ,1+σ),                                         
               ij ij ij ij                  openreview.net/forum?id=rJl-b3RcF7 (2018).

                                                                                  
                                                                                  
                                                                                  
                                                                                  
     Acknowledgements We thank L. Scheffer and L. Umayam for assistance with accessing investigator of the DFG-financed SFB 1233. J.K.L. is a member of the International Max Planck
     connectome reconstructions; A. Borst, J. Fitzgerald, N. Klapoetke, G. Rubin, M. Reiser, Research School for Intelligent Systems.
     K. Svoboda and members of the laboratories of S.C.T. and J.H.M. for discussions; J. Fitzgerald,
     D. Stern, N. Klapoetke, A. Lee, R. Gao, J. Voigts, B. Mensh, A. Schulz, P. Ramesh, M. Deistler, Author contributions Conceptualization, methodology: J.K.L., F.D.T., M.M., J.H.M. and S.C.T.
     Z. Stefanidi and J. Joyce for feedback on the manuscript; and T. Herman for creating and Data curation: J.K.L., F.D.T., A.N., K.S. and S.-y.T. Software and investigation: J.K.L., M.M., S.P. and
     sharing the colourization of the optic lobe figure25 (Fig. 1b). The graphics of the fruit fly and F.D.T. Analysis: J.K.L., E.G., A.N., S.P. and S.C.T. Writing: J.K.L., J.H.M. and S.C.T. Writing (review
     the electron microscope in Fig. 1a were created with BioRender.com. This article is subject to and editing): E.G., A.N., K.S., M.M., S.P. and F.D.T. Supervision and funding: J.H.M. and S.C.T.
     HHMI’s Open Access to Publications policy. HHMI laboratory heads have previously granted a
     nonexclusive CC BY 4.0 license to the public and a sublicensable licence to HHMI in their
     research articles. Pursuant to those licences, the author-accepted manuscript of this article Competing interests The authors declare no competing interests.
     can be made freely available under a CC BY 4.0 licence immediately on publication. This
     project was supported by the HHMI. J.K.L. and J.H.M. were supported by the German Research Additional information
     Foundation (DFG) through Germany’s Excellence Strategy (EXC-Number 2064/1, Project Supplementary information The online version contains supplementary material available at
     number 390727645), the German Federal Ministry of Education and Research (BMBF; Tübingen https://doi.org/10.1038/s41586-024-07939-3.
     AI Center, FKZ: 01IS18039A) and the European Union (ERC, DeepCoMechTome, 101089288). Correspondence and requests for materials should be addressed to Srinivas C. Turaga.
     Views and opinions expressed are however those of the author(s) alone and do not necessarily Peer review information Nature thanks the anonymous reviewers for their contribution to the
     reflect those of the European Union or the European Research Council. Neither the European peer review of this work. Peer reviewer reports are available.
     Union nor the granting authority can be held responsible for them. J.H.M. is the principal Reprints and permissions information is available at http://www.nature.com/reprints.
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  

                                                                                  
                                                                                  
     Article                                                                      
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
     Extended Data Fig. 1 | Cell connectivity. The matrix shows how cells of the 64 cell types within the inner 91 columns (of 721) of the recurrent convolutional DMN
     connect (Supplementary Data file 1), either by excitatory connections (red) or inhibitory connections (blue).
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  

                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
     Extended Data Fig. 2 | DMN benchmark of connectomic constraints. (a) Task error. (b) Predicted correlations to flash response indices, T4, and T5
     (a-d) How would incomplete knowledge of connectome affect the motion-tuning curves (10 best models). (c) Predicted correlations to known
     tuning predictions? We artificially varied DMNs with random parameters, direction selectivity indices. (d) Distances between known preferred directions
     connectome-constrained or task-optimized parameters. Five experiments: and predicted preferred directions for T4 and T5 neurons. (e) Better task-
     Four ‘Synapse-optimized models’, one ‘Fully optimized’. Details in Methods. performing models predict motion-tuning neurons better. We correlate
     How would incomplete knowledge of cell types affect the tuning predicted tuning metrics from each model to the known tuning properties to
     predictions? We artificially assumed some cell types to be indistinguishable, understand when better performing models give us better tuning predictions.
     with shared physiological parameters (resting potentials, time constants, (orange) When correlating the direction selectivity index of each model to the
     and unitary synapse strengths). Two experiments: (1) ‘Full DMN Merge T4, T5’ binary known properties for T4 and T5 and their input cell types, we find that
     assumes that T4 and T5 subtypes were indistinguishable, reducing the number this correlation is higher for better performing models (Pearson correlation,
     of cell types to 58. (2) ‘Full DMN Merge E/I’ assumes that we had three cell r=−0.60, p =2.6×10−6, t=r df , 95% CI = [−1, −0.42], df =48). (magenta) While
     types, excitatory (37 cell types), inhibitory (22 cell types) or both (4 cell types), the models predicted the kn1 o− wr2 n contrast preferences generally well, the
     based on our knowledge of synapse signs. Tuning predictions are shown in correlation of flash response index to the binary known contrast preferences of
     comparison to the Full DMN and the DMN with random parameters. 31 cell types did not significantly increase with better performing models.
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  

                                                                                  
                                                                                  
     Article                                                                      
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
     Extended Data Fig. 3 | DMNs suggest that TmY3 neurons compute motion synaptic connections in the pathway that projects onto TmY3 (simplified).
     independently of T4 and T5 neurons. (a) We clustered 50 DMNs after (e) The input elements of TmY3 with the highest amount of synapses are L4, L5,
     performing nonlinear dimensionality reduction of their responses to Tm2, Tm3, Mi1, Mi9, and Mi4. The asymmetries of their projective fields could
     naturalistic scenes for each cell type, and aimed to identify whether clusters allow TmY3 to become motion selective. (f) Dependencies between TmY3
     correspond to qualitatively different tuning mechanisms. (b) Dimensionality tuning and the contrast preference of its input cells. For clusters in which
     reduction on TmY3 responses to naturalistic stimuli reveals 4 clusters of DMNs TmY3 is motion selective, cluster 1 (TmY3 tuning to downwards/front-to-back
     with average task errors 5.298 (circle), 5.317 (triangle), 5.328 (square) and 5.331 motion, circular marker) indicates ON-selectivity for Tm3, Mi1, and Mi4 cells,
     (star). Across clusters, TmY3 shows different strengths of direction selectivity and OFF-selectivity for L4, Tm2, and Mi9 cells, in agreement with known
     (evaluated with moving edge stimuli). ON-edge direction selectivity is strong selectivities. In contrast, cluster 3 (TmY3 tuning to upwards/back-to-front
     in the first and the third cluster. (c) Normalized peak responses of TmY3 to motion, square marker) indicates ON-selectivity for Mi9 in contradiction to
     moving edge stimuli in the DMNs of each cluster. (d) Major cell types and the known selectivities and hence ruling out the third TmY3 tuning solution.
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  

                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
     Extended Data Fig. 4 | TmY3 motion detection mechanisms hypothesized by the model. (a) Responses to PD and ND ON-edge motion and contributions from
     input elements. (b) PD enhancement and ND suppression in TmY3 in the model.  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  

                                                                                  
                                                                                  
     Article                                                                      
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
     Extended Data Fig. 5 | Statistics of inhibitory and excitatory synapse of synaptic inputs against median predicted direction selectivity index for all
     inputs. (a) Number of input cell types per cell type. (b) Center of mass offsets cell types. Datapoints for cell types that were predicted as significantly motion
     of synaptic input. (c) Average excitatory and (d) inhibitory center of mass offset selective are labeled.
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  

                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
     Extended Data Fig. 6 | Predicted tuning with respect to task-performance. Known on-polar and off-polar cell types are colored in yellow and magenta.
     (a) Flash response index computed as the max-abs-scaled peak response to an (b) Single-cell type direction selectivity of best 20% task-performing models
     off flash subtracted from the max-abs-scaled peak response to an on flash – versus worst 20% task-performing models of an ensemble of 50 models as a
     both of approximately 35° radius and presented for 1 s after 2 s of grey input. result of peak voltage responses in central columns to on-edges and off-edges
     Values above 0 indicate on-polarity, values below zero indicate off-polarity. moving towards all possible directions on grey background.
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  

                                                                                  
                                                                                  
     Article                                                                      
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
     Extended Data Fig. 7 | T4 motion detection mechanisms hypothesized (second darkest, blue). Our model suggests mechanisms involving Mi9 cells
     by the model. (a) Across all T4 cell types (here T4c, Supplementary Fig. 5 for and TmY15 cells: both contribute to T4 motion detection by different inhibitory
     other T4 types), our model predicts that T4 depolarization in response to PD mechanisms for PD-motion with respect to ND-motion. (b) ‘Measured’:
     ON-motion (black, solid) is driven by excitatory Mi1 current inputs (darkest red, Predicted T4c responses to bars moving in PD (left column) and in ND (right
     solid) from roughly a two-column radius of Mi1 cells. Excitatory inputs from column) at varied speeds (saturated red and blue). ‘Linear sum’: linear sum
     neighboring T4 cells of the same type increase the T4 PD-motion response of responses to individually flashed frames that constitute the moving bar
     (third darkest red, solid). Tm3 and Mi1 cells excite T4 agnostic to PD vs. ND video (faint red and blue). Faint grey traces in background of first panel show
     motion. For ND-motion, Mi4 cells cancel excitatory currents from Mi1 with individual flash responses before linear summation. Flash duration in each
     matching inhibition from the trailing side of the receptive field (darkest blue, location matched to length of stay at the location in the moving bar video. Bars
     dashed). The inhibition from Mi4 cells is delayed for PD-motion (darkest blue, were approximately 9° wide and 20.25° high and moved across 45° with respect
     solid), allowing strong depolarization of T4. CT1 shadows the Mi4 mechanism to receptive field in the center. This figure should be compared to Gruntman
     with similar but weaker inhibition from the same location of the receptive field et al.27, Fig. 4f.
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  

                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
     Extended Data Fig. 8 | T5 motion detection mechanisms hypothesized field leading to the weak ND response. For PD-motion, inhibition from CT1(Lo1)
     by the model. (a) Across all T5 cell types (here T5c, Supplementary Fig. 6 for cells is delayed allowing strong T5 depolarization. (b) ‘Measured’: Predicted
     other T5 types), our model predicts that T5 depolarization in response to PD T5c responses to bars moving in PD (left column) and in ND (right column) at
     OFF-motion (black, solid) is driven by excitatory Tm1 and Tm9 input currents varied speeds (saturated red and blue). ‘Linear sum’: linear sum of responses
     (darkest and second darkest red). Tm1 currents come from a centered, to individually flashed frames that constitute the moving bar video (faint red
     two-column radius of Tm1 cells. Tm9 inputs come from cells offset by one and blue). Faint grey traces in background of first panel show individual flash
     column towards the leading side of the receptive field. We observe delayed responses before linear summation. Flash duration in each location matched to
     excitation from Tm9 cells for ND-motion. The PD-motion response is increased length of stay at the location in the moving bar video. Bars were approximately
     through excitatory inputs from the neighboring T5 cells of the same type (as for 9° wide and 20.25° high and moved across 45° with respect to receptive field in
     T4 cells), not providing excitation for ND-motion. CT1(Lo1) cells cancel excitatory the center.
     currents with strong inhibitory currents from the trailing side of the receptive
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  

                                                                                  
                                                                                  
     Article                                                                      
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
     Extended Data Fig. 9 | Spatio-temporal receptive fields mapped with ON- regularized naturalistic, artificial, and moving edge stimuli and responses.
     and OFF-impulses and maximally excitatory stimuli. (a) Spatiotemporal Moving edge angle and speed maximize the central cell peak response.
     receptive fields for motion detector neurons agree with experimental Artificial stimuli are optimized from initial noise to maximize the central cell
     measurements (Gruntman et al.27). (b) Spatio-temporal receptive field activity using gradient ascent plus full-field regularization towards grey. The
     mapping with single ommatidium OFF-impulses. (c) Maximally excitatory last row shows the baseline-subtracted central cell responses. Peak central cell
     stimuli and baseline-subtracted responses. Including full-field naturalistic, responses at time point zero.
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  
                                                                                  